{% extends "base.html" %}
{% block title %}Settings - Discord Pals{% endblock %}

{% block content %}
<style>
    .json-error { color: var(--danger); font-size: 0.85em; margin-top: 5px; padding: 8px; background: rgba(248,81,73,0.1); border-radius: 4px; display: none; }
    .extra-body-editor { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-top: 10px; }
    .extra-body-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; }
    .extra-body-row input, .extra-body-row select { padding: 6px 10px; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text); border-radius: 4px; font-size: 0.9em; }
    .extra-body-row input[name="eb-key"] { width: 150px; }
    .extra-body-row input[name="eb-value"] { flex: 1; }
    .extra-body-row select { width: 100px; }
    .extra-body-row .btn-sm { padding: 4px 10px; font-size: 0.85em; }
    .provider-card { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 15px; position: relative; }
    .provider-card.new { border-style: dashed; border-color: var(--accent); }
    .provider-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .provider-name { font-weight: 600; color: var(--accent); font-size: 1.1em; }
    .provider-badge { font-size: 0.75em; padding: 2px 8px; border-radius: 10px; background: var(--accent); color: var(--bg); margin-left: 10px; }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
    .form-group { display: flex; flex-direction: column; gap: 5px; }
    .form-group label { font-size: 0.85em; color: var(--text-muted); font-weight: 500; }
    .form-group input, .form-group select { padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text); border-radius: 6px; font-size: 0.95em; }
    .form-group input:focus, .form-gfocus { outline: none; border-color: var(--accent); }
    .form-group small { color: var(--text-muted); font-size: 0.8em; }
    .collapsible { cursor: pointer; user-select: none; }
    .collapsible::before { content: '‚ñ∂'; display: inline-block; margin-right: 8px; transition: transform 0.2s; }
    .collapsible.open::before { transform: rotate(90deg); }
    .collapse-content { display: none; margin-top: 10px; }
    .collapse-content.show { display: block; }
    .bot-card { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 15px; position: relative; }
    .bot-card.new { border-style: dashed; border-color: var(--success); }
    .action-row { display: flex; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); }
    .tab-container { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
    .tab-btn { padding: 10px 20px; background: transparent; border: none; color: var(--text-muted); cursor: pointer; border-radius: 6px 6px 0 0; font-size: 0.95em; }
    .tab-btn:hover { background: var(--bg); color: var(--text); }
    .tab-btn.active { background: var(--accent); color: var(--bg); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .delete-btn { position: absolute; top: 10px; right: 10px; background: transparent; border: none; color: var(--danger); cursor: pointer; font-size: 1.2em; opacity: 0.6; }
    .delete-btn:hover { opacity: 1; }
    .extra-body-toggle { cursor: pointer; color: var(--accent); font-size: 0.9em; margin-top: 10px; display: inline-block; }
</style>

<h1 style="margin-bottom: 30px;">‚öôÔ∏è Settings</h1>

{% if message %}
<div class="card" style="background: var(--success); margin-bottom: 20px;">
    <p style="margin: 0;">‚úì {{ message }}</p>
</div>
{% endif %}

{% if error %}
<div class="card" style="background: var(--danger); margin-bottom: 20px;">
    <p style="margin: 0;">‚úó {{ error }}</p>
</div>
{% endif %}

<!-- Export/Import -->
<div class="card">
    <h3 class="card-title">üì¶ Export / Import Configuration</h3>
    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
        <a href="/settings/export" class="btn btn-primary">‚¨áÔ∏è Export All Config</a>
        <form id="import-form" action="/settings/import" method="post" enctype="multipart/form-data" style="display: flex; gap: 10px; align-items: center;">
            <input type="file" name="config_zip" accept=".zip" style="background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 6px; border-radius: 4px;">
            <button type="submit" class="btn btn-secondary">‚¨ÜÔ∏è Import</button>
        </form>
        <span style="color: var(--text-muted); font-size: 0.85em;">Export/import providers.json, bots.json, autonomous.json</span>
    </div>
</div>

<!-- Tab Navigation -->
<div class="card">
    <div class="tab-container">
        <button class="tab-btn active" onclick="switchTab('providers')">üîå Providers</button>
        <button class="tab-btn" onclick="switchTab('bots')">ü§ñ Bots</button>
        <button class="tab-btn" onclick="switchTab('advanced')">üìù Advanced (JSON)</button>
    </div>

    <!-- Providers Tab -->
    <div id="tab-providers" class="tab-content active">
        <p style="color: var(--text-muted); margin-bottom: 15px;">Configure LLM providers. Changes require bot restart.</p>
        <div id="providers-form-container"></div>
        <button type="button" class="btn btn-secondary" onclick="addProvider()" style="margin-top: 10px;">
            ‚ûï Add Provider
        </button>
        <div style="margin-top: 20px;">
            <button type="button" class="btn btn-primary" onclick="saveProviders()">üíæ Save Providers</button>
            <span style="color: var(--text-muted); margin-left: 10px; font-size: 0.9em;">‚ö†Ô∏è Restart bot after changes</span>
        </div>
    </div>

    <!-- Bots Tab -->
    <div id="tab-bots" class="tab-content">
        <p style="color: var(--text-muted); margin-bottom: 15px;">Configure bot instances. Changes require bot restart.</p>
        <div id="bots-form-container"></div>
        <button type="button" class="btn btn-secondary" onclick="addBot()" style="margin-top: 10px;">
            ‚ûï Add Bot
        </button>
        <div style="margin-top: 20px;">
            <button type="button" class="btn btn-primary" onclick="saveBots()">üíæ Save Bots</button>
            <span style="color: var(--text-muted); margin-left: 10px; font-size: 0.9em;">‚ö†Ô∏è Restart bot after changes</span>
        </div>
    </div>

    <!-- Advanced Tab -->
    <div id="tab-advanced" class="tab-content">
        <p style="color: var(--text-muted); margin-bottom: 15px;">Direct JSON editing for advanced users.</p>
        
        <!-- Providers JSON -->
        <div style="margin-bottom: 20px;">
            <h4 style="margin-bottom: 10px;">providers.json</h4>
            <form id="providers-form" action="/settings/providers/save" method="post" onsubmit="return validateJSON('providers-textarea', 'providers-error')">
                <textarea id="providers-textarea" name="content" style="width: 100%; height: 250px; font-family: monospace; font-size: 13px; 
                    background: var(--bg); border: 1px solid var(--border); color: var(--text); 
                    padding: 15px; border-radius: 4px; resize: vertical;">{{ providers_raw }}</textarea>
                <div id="providers-error" class="json-error"></div>
                <div style="margin-top: 10px;">
                    <button type="submit" class="btn btn-primary">Save Providers</button>
                    <button type="button" class="btn btn-secondary" onclick="testProvider(0)" style="margin-left: 5px;">üîå Test Primary</button>
                </div>
            </form>
        </div>

        <!-- Bots JSON -->
        <div style="margin-bottom: 20px;">
            <h4 style="margin-bottom: 10px;">bots.json</h4>
            <form id="bots-form" action="/settings/bots/save" method="post" onsubmit="return validateJSON('bots-textarea', 'bots-error')">
                <textarea id="bots-textarea" name="content" style="width: 100%; height: 150px; font-family: monospace; font-size: 13px; 
                    background: var(--bg); border: 1px solid var(--border); color: var(--text); 
                    padding: 15px; border-radius: 4px; resize: vertical;">{{ bots_raw }}</textarea>
                <div id="bots-error" class="json-error"></div>
                <div style="margin-top: 10px;">
                    <button type="submit" class="btn btn-primary">Save Bots</button>
                </div>
            </form>
        </div>

        <!-- Autonomous JSON -->
        <div>
            <h4 style="margin-bottom: 10px;">autonomous.json</h4>
            <form id="autonomous-form" action="/settings/autonomous/save" method="post" onsubmit="return validateJSON('autonomous-textarea', 'autonomous-error')">
                <textarea id="autonomous-textarea" name="content" style="width: 100%; height: 120px; font-family: monospace; font-size: 13px; 
                    background: var(--bg); border: 1px solid var(--border); color: var(--text); 
                    padding: 15px; border-radius: 4px; resize: vertical;">{{ autonomous_raw }}</textarea>
                <div id="autonomous-error" class="json-error"></div>
                <div style="margin-top: 10px;">
                    <button type="submit" class="btn btn-primary">Save Autonomous</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let providersData = null;
let botsData = null;

try { providersData = JSON.parse(document.getElementById('providers-textarea').value); } catch(e) { providersData = { providers: [] }; }
try { botsData = JSON.parse(document.getElementById('bots-textarea').value); } catch(e) { botsData = { bots: [] }; }

// Tab switching
function switchTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
    document.getElementById('tab-' + tabName).classList.add('active');
}

function validateJSON(textareaId, errorId) {
    const textarea = document.getElementById(textareaId);
    const errorDiv = document.getElementById(errorId);
    try {
        JSON.parse(textarea.value);
        errorDiv.style.display = 'none';
        return true;
    } catch(e) {
        errorDiv.textContent = '‚ùå Invalid JSON: ' + e.message;
        errorDiv.style.display = 'block';
        return false;
    }
}

// Provider form rendering
function renderProviderForms() {
    const container = document.getElementById('providers-form-container');
    if (!providersData || !providersData.providers) {
        providersData = { providers: [] };
    }
    
    let html = '';
    providersData.providers.forEach((p, idx) => {
        html += createProviderCard(p, idx);
    });
    
    container.innerHTML = html || '<p style="color: var(--text-muted);">No providers configured. Click "Add Provider" to create one.</p>';
}

function createProviderCard(provider, idx) {
    const extraBody = provider.extra_body || {};
    const extraBodyRows = Object.entries(extraBody).map(([k, v]) => createExtraBodyRow(k, v)).join('');
    
    return `
    <div class="provider-card" data-idx="${idx}">
        <button type="button" class="delete-btn" onclick="deleteProvider(${idx})" title="Delete provider">√ó</button>
        <div class="provider-header">
            <span class="provider-name">${provider.name || 'Provider ' + (idx + 1)}</span>
            ${idx === 0 ? '<span class="provider-badge">Primary</span>' : ''}
            <button type="button" class="btn btn-secondary btn-sm" onclick="testProvider(${idx})">üîå Test</button>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Name</label>
                <input type="text" value="${provider.name || ''}" onchange="updateProvider(${idx}, 'name', this.value)" placeholder="My Provider">
            </div>
            <div class="form-group">
                <label>API URL</label>
                <input type="text" value="${provider.url || ''}" onchange="updateProvider(${idx}, 'url', this.value)" placeholder="http://localhost:5000/v1">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Model</label>
                <input type="text" value="${provider.model || ''}" onchange="updateProvider(${idx}, 'model', this.value)" placeholder="gpt-4">
            </div>
            <div class="form-group">
                <label>API Key Env Variable</label>
                <input type="text" value="${provider.key_env || ''}" onchange="updateProvider(${idx}, 'key_env', this.value)" placeholder="OPENAI_API_KEY">
                <small>Leave empty if not needed</small>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Max Tokens</label>
                <input type="number" value="${provider.max_tokens || 2048}" onchange="updateProvider(${idx}, 'max_tokens', parseInt(this.value))" min="100" max="32000">
            </div>
            <div class="form-group">
                <label>Temperature</label>
                <input type="number" value="${provider.temperature || 0.7}" onchange="updateProvider(${idx}, 'temperature', parseFloat(this.value))" min="0" max="2" step="0.1">
            </div>
        </div>
        <span class="extra-body-toggle" onclick="toggleExtraBody(${idx})">‚ñ∂ Extra Body Parameters</span>
        <div class="extra-body-editor" id="eb-${idx}" style="display: none;">
            ${extraBodyRows}
            <button type="button" class="btn btn-sm btn-secondary" onclick="addExtraBodyRow(${idx})">+ Add Parameter</button>
        </div>
    </div>`;
}

function toggleExtraBody(idx) {
    const editor = document.getElementById('eb-' + idx);
    const toggle = editor.previousElementSibling;
    if (editor.style.display === 'none') {
        editor.style.display = 'block';
        toggle.textContent = '‚ñº Extra Body Parameters';
    } else {
        editor.style.display = 'none';
        toggle.textContent = '‚ñ∂ Extra Body Parameters';
    }
}

function createExtraBodyRow(key, value) {
    const type = typeof value === 'boolean' ? 'boolean' : typeof value === 'number' ? 'number' : value === null ? 'null' : 'string';
    const displayValue = type === 'null' ? '' : value;
    return `<div class="extra-body-row">
        <input type="text" name="eb-key" value="${key}" placeholder="key">
        <input type="text" name="eb-value" value="${displayValue}" placeholder="value">
        <select name="eb-type">
            <option value="string" ${type==='string'?'selected':''}>String</option>
            <option value="number" ${type==='number'?'selected':''}>Number</option>
            <option value="boolean" ${type==='boolean'?'selected':''}>Boolean</option>
            <option value="null" ${type==='null'?'selected':''}>Null</option>
        </select>
        <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">√ó</button>
    </div>`;
}

function addExtraBodyRow(idx) {
    const editor = document.getElementById('eb-' + idx);
    const btn = editor.querySelector('button:last-child');
    const div = document.createElement('div');
    div.innerHTML = createExtraBodyRow('', '');
    editor.insertBefore(div.firstChild, btn);
}

function updateProvider(idx, field, value) {
    if (!providersData.providers[idx]) return;
    providersData.providers[idx][field] = value;
    
    // Update name display
    if (field === 'name') {
        const card = document.querySelector(`.provider-card[data-idx="${idx}"]`);
        card.querySelector('.provider-name').textContent = value || 'Provider ' + (idx + 1);
    }
}

function addProvider() {
    providersData.providers.push({
        name: 'New Provider',
        url: '',
        model: '',
        key_env: '',
        max_tokens: 2048,
        temperature: 0.7,
        extra_body: {}
    });
    renderProviderForms();
}

function deleteProvider(idx) {
    showConfirm('Delete Provider', 'Are you sure you want to delete this provider?', () => {
        providersData.providers.splice(idx, 1);
        renderProviderForms();
    });
}

function collectExtraBodies() {
    document.querySelectorAll('.provider-card').forEach(card => {
        const idx = parseInt(card.dataset.idx);
        const extraBody = {};
        card.querySelectorAll('.extra-body-row').forEach(row => {
            const key = row.querySelector('[name="eb-key"]').value.trim();
            const rawValue = row.querySelector('[name="eb-value"]').value;
            const type = row.querySelector('[name="eb-type"]').value;
            if (!key) return;
            let value;
            if (type === 'number') value = parseFloat(rawValue) || 0;
            else if (type === 'boolean') value = rawValue.toLowerCase() === 'true';
            else if (type === 'null') value = null;
            else value = rawValue;
            extraBody[key] = value;
        });
        providersData.providers[idx].extra_body = extraBody;
    });
}

function saveProviders() {
    collectExtraBodies();
    document.getElementById('providers-textarea').value = JSON.stringify(providersData, null, 2);
    
    fetch('/settings/providers/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'content=' + encodeURIComponent(JSON.stringify(providersData, null, 2))
    }).then(r => {
        if (r.ok) showToast('Providers saved! Restart bot to apply changes.', 'success');
        else showToast('Failed to save providers', 'error');
    });
}

// Bot form rendering
function renderBotForms() {
    const container = document.getElementById('bots-form-container');
    if (!botsData || !botsData.bots) {
        botsData = { bots: [] };
    }
    
    let html = '';
    botsData.bots.forEach((b, idx) => {
        html += createBotCard(b, idx);
    });
    
    container.innerHTML = html || '<p style="color: var(--text-muted);">No bots configured. Click "Add Bot" to create one.</p>';
}

function createBotCard(bot, idx) {
    return `
    <div class="bot-card" data-idx="${idx}">
        <button type="button" class="delete-btn" onclick="deleteBot(${idx})" title="Delete bot">√ó</button>
        <div class="form-row">
            <div class="form-group">
                <label>Bot Name</label>
                <input type="text" value="${bot.name || ''}" onchange="updateBot(${idx}, 'name', this.value)" placeholder="MyBot">
            </div>
            <div class="form-group">
                <label>Token Env Variable</label>
                <input type="text" value="${bot.token_env || ''}" onchange="updateBot(${idx}, 'token_env', this.value)" placeholder="DISCORD_TOKEN">
                <small>Environment variable containing the Discord token</small>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Character</label>
                <input type="text" value="${bot.character || ''}" onchange="updateBot(${idx}, 'character', this.value)" placeholder="firefly">
                <small>Character file name (without .md)</small>
            </div>
        </div>
    </div>`;
}

function updateBot(idx, field, value) {
    if (!botsData.bots[idx]) return;
    botsData.bots[idx][field] = value;
}

function addBot() {
    botsData.bots.push({
        name: 'NewBot',
        token_env: 'DISCORD_TOKEN',
        character: ''
    });
    renderBotForms();
}

function deleteBot(idx) {
    showConfirm('Delete Bot', 'Are you sure you want to delete this bot?', () => {
        botsData.bots.splice(idx, 1);
        renderBotForms();
    });
}

function saveBots() {
    document.getElementById('bots-textarea').value = JSON.stringify(botsData, null, 2);
    
    fetch('/settings/bots/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'content=' + encodeURIComponent(JSON.stringify(botsData, null, 2))
    }).then(r => {
        if (r.ok) showToast('Bots saved! Restart bot to apply changes.', 'success');
        else showToast('Failed to save bots', 'error');
    });
}

async function testProvider(idx) {
    showToast('Testing provider...', 'warning');
    try {
        const r = await fetch('/api/test-provider/' + idx);
        const data = await r.json();
        if (data.success) showToast('‚úì Provider ' + (idx+1) + ' connected!', 'success');
        else showToast('‚úó ' + (data.error || 'Connection failed'), 'error');
    } catch(e) {
        showToast('‚úó Test failed: ' + e.message, 'error');
    }
}

// Initialize forms
renderProviderForms();
renderBotForms();
</script>
{% endblock %}
