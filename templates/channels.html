{% extends "base.html" %}
{% block title %}Channels - Discord Pals{% endblock %}

{% block content %}
<h1 style="margin-bottom: 30px;">üì∫ Channel Management</h1>

<!-- Filter Controls -->
<div class="card">
    <div class="filter-row">
        <div class="filter-group">
            <label for="guild-filter">Filter by Server:</label>
            <select id="guild-filter" onchange="filterChannels()">
                <option value="">All Servers</option>
                {% for guild in guilds %}
                <option value="{{ guild.id }}">{{ guild.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="auto-filter">Autonomous:</label>
            <select id="auto-filter" onchange="filterChannels()">
                <option value="">All</option>
                <option value="enabled">Enabled Only</option>
                <option value="disabled">Disabled Only</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="history-filter">Has History:</label>
            <select id="history-filter" onchange="filterChannels()">
                <option value="">All</option>
                <option value="yes">With History</option>
                <option value="no">No History</option>
            </select>
        </div>
    </div>
</div>

<!-- Channels Table -->
<div class="card">
    <h3 class="card-title">Channels <span id="channel-count" style="color: var(--text-muted); font-weight: normal;">({{ channels|length }} total)</span></h3>
    
    {% if channels %}
    <table id="channels-table">
        <thead>
            <tr>
                <th>Channel</th>
                <th>Server</th>
                <th>History</th>
                <th>Autonomous</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for channel in channels %}
            <tr data-channel-id="{{ channel.id }}" 
                data-guild-id="{{ channel.guild_id }}"
                data-autonomous="{{ 'enabled' if channel.autonomous else 'disabled' }}"
                data-has-history="{{ 'yes' if channel.history_count > 0 else 'no' }}">
                <td>
                    <strong>#{{ channel.name }}</strong>
                    <small style="display: block; color: var(--text-muted);">ID: {{ channel.id }}</small>
                </td>
                <td>{{ channel.guild_name }}</td>
                <td>
                    <span class="history-count {% if channel.history_count > 0 %}has-history{% endif %}">
                        {{ channel.history_count }} messages
                    </span>
                </td>
                <td>
                    <div class="auto-status" id="auto-status-{{ channel.id }}">
                        {% if channel.autonomous %}
                        <span class="badge badge-success auto-toggle" onclick="quickToggleAuto({{ channel.id }}, false)" title="Click to disable">‚óè ON</span>
                        <small>{{ channel.auto_chance }}% / {{ channel.auto_cooldown }}min{% if channel.allow_bot_triggers %} ü§ñ{% endif %}</small>
                        {% else %}
                        <span class="badge badge-danger auto-toggle" onclick="quickToggleAuto({{ channel.id }}, true)" title="Click to enable">‚óè OFF</span>
                        {% endif %}
                    </div>
                </td>
              <td>
                    <div class="action-buttons">
                        <button class="btn btn-small btn-secondary" onclick="openAutoModal({{ channel.id }}, '{{ channel.name }}', {{ 'true' if channel.autonomous else 'false' }}, {{ channel.auto_chance }}, {{ channel.auto_cooldown }}, {{ 'true' if channel.allow_bot_triggers else 'false' }})">
                            ‚öôÔ∏è Configure
                        </button>
                        <button class="btn btn-small btn-danger" onclick="clearHistory({{ channel.id }}, '{{ channel.name }}')" {% if channel.history_count == 0 %}disabled{% endif %}>
                            üóëÔ∏è Clear
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty">
        <p>No channels found. Make sure your bots are online and connected to servers.</p>
    </div>
    {% endif %}
</div>

<!-- Autonomous Configuration Modal -->
<div id="auto-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>‚öôÔ∏è Configure Channel</h3>
        <p id="auto-modal-channel" style="color: var(--text-muted); margin-bottom: 20px;"></p>
        
        <!-- Autonomous Mode Section -->
        <div class="config-section">
            <h4>üé≤ Autonomous Mode</h4>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="auto-enabled">
                    Enable Autonomous Responses
                </label>
                <small>Bot will occasionally respond without being mentioned (includes name triggers)</small>
            </div>
            
            <div class="form-group" id="auto-settings">
                <label for="auto-chance">Response Chance: <span id="chance-val">5</span>%</label>
                <input type="range" id="auto-chance" min="1" max="50" value="5"
                       oninput="document.getElementById('chance-val').textContent = this.value">
                
                <label for="auto-cooldown" style="margin-top: 15px;">Cooldown: <span id="cooldown-val">2</span> minutes</label>
                <input type="range" id="auto-cooldown" min="1" max="10" value="2"
                       oninput="document.getElementById('cooldown-val').textContent = this.value">
            </div>
        </div>
        
        <!-- Name Trigger Section -->
        <div class="config-section">
            <h4>üè∑Ô∏è Name Triggers</h4>
            <small class="section-desc">Bot responds when its name/nickname is mentioned (requires autonomous mode)</small>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="auto-allow-bots">
                    ü§ñ Allow Bot/App Triggers
                </label>
                <small>When enabled, other Discord bots/apps can trigger name-based responses (not just humans)</small>
            </div>
            
            <div class="form-group" id="nickname-settings">
                <label>Bot Nicknames</label>
                <small>Comma-separated list of additional names the bot responds to</small>
                <div id="bot-nicknames-container">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <div class="modal-buttons">
            <button class="btn btn-secondary" onclick="closeAutoModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveAutoConfig()">Save</button>
        </div>
        
        <input type="hidden" id="auto-channel-id">
    </div>
</div>

<style>
.filter-row {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.filter-group label {
    color: var(--text-muted);
    font-size: 0.9em;
}

.filter-group select {
    padding: 8px 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
}

.history-count {
    color: var(--text-muted);
}

.history-count.has-history {
    color: var(--accent);
    font-weight: 500;
}

.auto-status {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.auto-status small {
    color: var(--text-muted);
    font-size: 0.8em;
}

.action-buttons {
    display: flex;
    gap: 8px;
}

.btn-small {
    padding: 6px 12px;
    font-size: 0.85em;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.modal-content {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    max-width: 450px;
    width: 90%;
}

.modal-content h3 {
    margin-bottom: 8px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
}

.form-group small {
    display: block;
    color: var(--text-muted);
    margin-top: 4px;
    font-size: 0.85em;
}

.form-group input[type="range"] {
    width: 100%;
    margin-top: 8px;
}

.modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 24px;
}

tr.hidden {
    display: none;
}

/* Clickable autonomous toggle badges */
.auto-toggle {
    cursor: pointer;
    transition: all 0.2s ease;
}

.auto-toggle:hover {
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.badge-success.auto-toggle:hover {
    background: rgba(248, 81, 73, 0.3);
    color: var(--danger);
}

.badge-danger.auto-toggle:hover {
    background: rgba(63, 185, 80, 0.3);
    color: var(--success);
}

/* Config sections in modal */
.config-section {
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border);
}

.config-section:last-of-type {
    border-bottom: none;
}

.config-section h4 {
    margin-bottom: 12px;
    color: var(--accent);
    font-size: 1em;
}

.section-desc {
    display: block;
    color: var(--text-muted);
    margin-bottom: 15px;
    font-size: 0.85em;
}

/* Nickname input rows */
.nickname-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    padding: 8px;
    background: var(--bg);
    border-radius: 6px;
}

.nickname-row .bot-name {
    min-width: 100px;
    font-weight: 500;
    color: var(--accent);
}

.nickname-row input {
    flex: 1;
    padding: 6px 10px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
}

.nickname-row input:focus {
    outline: none;
    border-color: var(--accent);
}

.modal-content {
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
}
</style>

<script>
let currentChannelId = null;
let botNicknames = {};  // Cache for bot nicknames

// Load bot nicknames on page load
async function loadBotNicknames() {
    try {
        const response = await fetch('/api/nicknames');
        const data = await response.json();
        botNicknames = data.nicknames || {};
    } catch (e) {
        console.error('Failed to load bot nicknames:', e);
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', loadBotNicknames);

// Filter channels
function filterChannels() {
    const guildFilter = document.getElementById('guild-filter').value;
    const autoFilter = document.getElementById('auto-filter').value;
    const historyFilter = document.getElementById('history-filter').value;
    
    const rows = document.querySelectorAll('#channels-table tbody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        let show = true;
        
        if (guildFilter && row.dataset.guildId !== guildFilter) {
            show = false;
        }
        
        if (autoFilter && row.dataset.autonomous !== autoFilter) {
            show = false;
        }
        
        if (historyFilter && row.dataset.hasHistory !== historyFilter) {
            show = false;
        }
        
        row.classList.toggle('hidden', !show);
        if (show) visibleCount++;
    });
    
    document.getElementById('channel-count').textContent = `(${visibleCount} shown)`;
}

// Open autonomous configuration modal
function openAutoModal(channelId, channelName, enabled, chance, cooldown, allowBots) {
    currentChannelId = channelId;
    document.getElementById('auto-modal-channel').textContent = `#${channelName}`;
    document.getElementById('auto-channel-id').value = channelId;
    document.getElementById('auto-enabled').checked = enabled;
    document.getElementById('auto-chance').value = chance;
    document.getElementById('chance-val').textContent = chance;
    document.getElementById('auto-cooldown').value = cooldown;
    document.getElementById('cooldown-val').textContent = cooldown;
    document.getElementById('auto-allow-bots').checked = allowBots || false;
    
    // Populate nickname inputs for each bot
    const container = document.getElementById('bot-nicknames-container');
    container.innerHTML = '';
    
    for (const [botName, nicknames] of Object.entries(botNicknames)) {
        const row = document.createElement('div');
        row.className = 'nickname-row';
        row.innerHTML = `
            <span class="bot-name">${botName}</span>
            <input type="text"
                   id="nickname-${botName.replace(/\s+/g, '-')}"
                   data-bot-name="${botName}"
                   value="${nicknames || ''}"
                   placeholder="e.g., bestie, buddy">
        `;
        container.appendChild(row);
    }
    
    // If no bots loaded yet, show a message
    if (Object.keys(botNicknames).length === 0) {
        container.innerHTML = '<small style="color: var(--text-muted);">Loading bot info...</small>';
        // Try to reload
        loadBotNicknames().then(() => {
            if (Object.keys(botNicknames).length > 0) {
                openAutoModal(channelId, channelName, enabled, chance, cooldown, allowBots);
            }
        });
    }
    
    document.getElementById('auto-modal').style.display = 'flex';
    
    // Toggle settings visibility based on enabled state
    toggleAutoSettings();
}

function closeAutoModal() {
    document.getElementById('auto-modal').style.display = 'none';
    currentChannelId = null;
}

function toggleAutoSettings() {
    const enabled = document.getElementById('auto-enabled').checked;
    document.getElementById('auto-settings').style.opacity = enabled ? '1' : '0.5';
}

document.getElementById('auto-enabled').addEventListener('change', toggleAutoSettings);

// Save autonomous configuration and nicknames
async function saveAutoConfig() {
    const channelId = document.getElementById('auto-channel-id').value;
    const enabled = document.getElementById('auto-enabled').checked;
    const chance = parseInt(document.getElementById('auto-chance').value);
    const cooldown = parseInt(document.getElementById('auto-cooldown').value);
    const allowBotTriggers = document.getElementById('auto-allow-bots').checked;
    
    let hasErrors = false;
    
    // Save nicknames for each bot
    const nicknameInputs = document.querySelectorAll('#bot-nicknames-container input[data-bot-name]');
    for (const input of nicknameInputs) {
        const botName = input.dataset.botName;
        const nicknames = input.value.trim();
        
        // Only save if changed
        if (botNicknames[botName] !== nicknames) {
            try {
                const response = await fetch('/api/nicknames', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bot_name: botName, nicknames: nicknames })
                });
                
                const data = await response.json();
                if (data.status === 'ok') {
                    botNicknames[botName] = nicknames;  // Update cache
                } else {
                    hasErrors = true;
                }
            } catch (e) {
                hasErrors = true;
            }
        }
    }
    
    // Save autonomous settings
    try {
        const response = await fetch(`/api/channels/${channelId}/autonomous`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ enabled, chance, cooldown, allow_bot_triggers: allowBotTriggers })
        });
        
        const data = await response.json();
        
        if (data.status === 'ok') {
            // Update the row
            const row = document.querySelector(`tr[data-channel-id="${channelId}"]`);
            if (row) {
                row.dataset.autonomous = enabled ? 'enabled' : 'disabled';
                const statusDiv = document.getElementById(`auto-status-${channelId}`);
                const botIcon = allowBotTriggers ? ' ü§ñ' : '';
                if (enabled) {
                    statusDiv.innerHTML = `
                        <span class="badge badge-success auto-toggle" onclick="quickToggleAuto(${channelId}, false)" title="Click to disable">‚óè ON</span>
                        <small>${chance}% / ${cooldown}min${botIcon}</small>
                    `;
                } else {
                    statusDiv.innerHTML = `<span class="badge badge-danger auto-toggle" onclick="quickToggleAuto(${channelId}, true)" title="Click to enable">‚óè OFF</span>`;
                }
            }
            
            if (hasErrors) {
                showToast('Settings saved (some nickname updates failed)', 'warning');
            } else {
                showToast('All settings saved!', 'success');
            }
            closeAutoModal();
        } else {
            showToast('Failed to save configuration', 'error');
        }
    } catch (e) {
        showToast('Error saving configuration', 'error');
    }
}

// Clear channel history
function clearHistory(channelId, channelName) {
    showConfirm(
        'Clear History',
        `Are you sure you want to clear all conversation history for #${channelName}? This cannot be undone.`,
        async () => {
            try {
                const response = await fetch(`/api/channels/${channelId}/clear`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.status === 'ok') {
                    // Update the row
                    const row = document.querySelector(`tr[data-channel-id="${channelId}"]`);
                    if (row) {
                        row.dataset.hasHistory = 'no';
                        const countSpan = row.querySelector('.history-count');
                        countSpan.textContent = '0 messages';
                        countSpan.classList.remove('has-history');
                        
                        // Disable the clear button
                        const clearBtn = row.querySelector('.btn-danger');
                        if (clearBtn) clearBtn.disabled = true;
                    }
                    
                    showToast(`History cleared for #${channelName}`, 'success');
                } else {
                    showToast('Failed to clear history', 'error');
                }
            } catch (e) {
                showToast('Error clearing history', 'error');
            }
        }
    );
}

// Close modal on outside click
document.getElementById('auto-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeAutoModal();
    }
});

// Quick toggle autonomous mode (click on badge)
async function quickToggleAuto(channelId, enable) {
    try {
        // First get current settings to preserve them
        const getResponse = await fetch(`/api/channels/${channelId}/autonomous`);
        const currentSettings = await getResponse.json();
        
        // Use current values or defaults for quick toggle
        const chance = currentSettings.chance || 5;
        const cooldown = currentSettings.cooldown || 2;
        const allowBotTriggers = currentSettings.allow_bot_triggers || false;
        
        const response = await fetch(`/api/channels/${channelId}/autonomous`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ enabled: enable, chance, cooldown, allow_bot_triggers: allowBotTriggers })
        });
        
        const data = await response.json();
        
        if (data.status === 'ok') {
            // Update the row
            const row = document.querySelector(`tr[data-channel-id="${channelId}"]`);
            if (row) {
                row.dataset.autonomous = enable ? 'enabled' : 'disabled';
                const statusDiv = document.getElementById(`auto-status-${channelId}`);
                const botIcon = data.allow_bot_triggers ? ' ü§ñ' : '';
                if (enable) {
                    statusDiv.innerHTML = `
                        <span class="badge badge-success auto-toggle" onclick="quickToggleAuto(${channelId}, false)" title="Click to disable">‚óè ON</span>
                        <small>${data.chance}% / ${data.cooldown}min${botIcon}</small>
                    `;
                } else {
                    statusDiv.innerHTML = `<span class="badge badge-danger auto-toggle" onclick="quickToggleAuto(${channelId}, true)" title="Click to enable">‚óè OFF</span>`;
                }
            }
            
            showToast(enable ? '‚úÖ Autonomous mode enabled' : '‚úÖ Autonomous mode disabled', 'success');
        } else {
            showToast('Failed to toggle autonomous mode', 'error');
        }
    } catch (e) {
        showToast('Error toggling autonomous mode', 'error');
    }
}
</script>
{% endblock %}
