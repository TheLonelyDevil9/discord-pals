{% extends "base.html" %}
{% block title %}Live Logs - Discord Pals{% endblock %}

{% block content %}
<style>
    .logs-controls {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        align-items: center;
    }

    .logs-container {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 15px;
        height: 600px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 0.9em;
    }

    .log-entry {
        padding: 6px 10px;
        border-radius: 4px;
        margin-bottom: 4px;
        display: flex;
        gap: 10px;
    }

    .log-entry:hover {
        background: var(--bg);
    }

    .log-time {
        color: var(--text-muted);
        flex-shrink: 0;
    }

    .log-icon {
        flex-shrink: 0;
        width: 20px;
        text-align: center;
    }

    .log-bot {
        color: var(--accent);
        flex-shrink: 0;
        min-width: 80px;
    }

    .log-message {
        flex: 1;
        word-break: break-word;
    }

    .log-ok .log-icon {
        color: var(--success);
    }

    .log-warn .log-icon {
        color: var(--warning);
    }

    .log-error .log-icon {
        color: var(--danger);
    }

    .log-info .log-icon {
        color: var(--accent);
    }

    .auto-scroll-indicator {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        color: var(--text-muted);
        font-size: 0.9em;
    }

    .auto-scroll-indicator.active {
        color: var(--success);
    }

    #log-count {
        color: var(--text-muted);
    }
</style>

<h1>üìã Live Logs</h1>
<p style="color: var(--text-muted); margin-bottom: 20px;">
    Real-time log stream from bot activity.
</p>

<div class="logs-controls">
    <button class="btn btn-primary" onclick="toggleAutoScroll()">
        <span id="auto-scroll-btn">‚è∏ Pause</span>
    </button>
    <button class="btn" onclick="clearLogs()">Clear</button>
    <span id="log-count">0 entries</span>
    <span class="auto-scroll-indicator" id="scroll-indicator">
        <span id="scroll-dot">‚óè</span> Auto-scroll
    </span>
</div>

<div class="logs-container" id="logs-container">
    <div style="text-align: center; color: var(--text-muted); padding: 20px;">
        Loading logs...
    </div>
</div>

<script>
    let autoScroll = true;
    let lastLogCount = 0;

    function toggleAutoScroll() {
        autoScroll = !autoScroll;
        document.getElementById('auto-scroll-btn').textContent = autoScroll ? '‚è∏ Pause' : '‚ñ∂ Resume';
        document.getElementById('scroll-indicator').className = 'auto-scroll-indicator' + (autoScroll ? ' active' : '');
    }

    function clearLogs() {
        document.getElementById('logs-container').innerHTML = '';
        lastLogCount = 0;
        updateLogCount(0);
    }

    function updateLogCount(count) {
        document.getElementById('log-count').textContent = count + ' entries';
    }

    function renderLogs(logs) {
        const container = document.getElementById('logs-container');

        if (logs.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">No logs yet</div>';
            updateLogCount(0);
            return;
        }

        let html = '';
        for (const log of logs) {
            const bot = log.bot ? `[${log.bot}]` : '';
            html += `<div class="log-entry log-${log.level}">
            <span class="log-time">${log.time}</span>
            <span class="log-icon">${log.icon}</span>
            <span class="log-bot">${bot}</span>
            <span class="log-message">${escapeHtml(log.message)}</span>
        </div>`;
        }

        container.innerHTML = html;
        updateLogCount(logs.length);

        if (autoScroll) {
            container.scrollTop = container.scrollHeight;
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function fetchLogs() {
        try {
            const response = await fetch('/api/logs');
            const logs = await response.json();

            if (logs.length !== lastLogCount) {
                renderLogs(logs);
                lastLogCount = logs.length;
            }
        } catch (err) {
            console.error('Failed to fetch logs:', err);
        }
    }

    // Initial fetch and polling
    fetchLogs();
    setInterval(fetchLogs, 2000);
</script>
{% endblock %}