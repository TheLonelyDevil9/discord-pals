{% extends "base.html" %}
{% block title %}Logs - Discord Pals{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Logs & Stats</h1>
    <p class="page-subtitle">Live activity logs and usage statistics</p>
</div>

<!-- Tab Navigation -->
<div class="tabs">
    <button type="button" class="tab active" onclick="switchTab('live')">Live Logs</button>
    <button type="button" class="tab" onclick="switchTab('stats')">Stats</button>
    <button type="button" class="tab" onclick="switchTab('context')">Context</button>
</div>

<!-- Live Logs Tab -->
<div id="tab-live" class="tab-content active">
    <div class="card">
        <div class="logs-controls">
            <button type="button" class="btn btn-primary btn-sm" onclick="toggleAutoScroll()">
                <span id="auto-scroll-btn">Pause</span>
            </button>
            <button type="button" class="btn btn-ghost btn-sm" onclick="clearLogs()">Clear</button>
            <input type="text" id="log-search" placeholder="Search logs..." oninput="filterLogs()" title="Search logs">
            <select id="log-level-filter" onchange="filterLogs()" title="Filter by level">
                <option value="">All Levels</option>
                <option value="ok">Success</option>
                <option value="info">Info</option>
                <option value="warn">Warning</option>
                <option value="error">Error</option>
            </select>
            <span class="log-count" id="log-count">0 entries</span>
            <span class="auto-scroll-indicator active" id="scroll-indicator" onclick="toggleAutoScroll()">
                <span class="scroll-dot" id="scroll-dot"></span>
                Auto-scroll
            </span>
        </div>
        <div class="logs-container" id="logs-container">
            <div class="logs-empty">Loading logs...</div>
        </div>
    </div>
</div>

<!-- Stats Tab -->
<div id="tab-stats" class="tab-content">
    {% if stats.created_at %}
    <p class="stats-since">Tracking since {{ stats.created_at[:10] }}</p>
    {% endif %}

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ stats.total_messages }}</div>
            <div class="stat-label">Messages</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.total_responses }}</div>
            <div class="stat-label">Responses</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ (stats.avg_response_time_ms / 1000) | round(1) }}s</div>
            <div class="stat-label">Avg Time</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.top_users | length }}</div>
            <div class="stat-label">Users</div>
        </div>
    </div>

    {% if stats.recent_days %}
    <div class="card">
        <div class="card-header">
            <span class="card-title">Last 7 Days</span>
        </div>
        <div class="card-body">
            <div class="chart-bars">
                {% set max_msgs = stats.recent_days | map(attribute='messages') | max %}
                {% for day in stats.recent_days %}
                <div class="chart-bar-wrapper">
                    <span class="chart-value">{{ day.messages }}</span>
                    <div class="chart-bar" style="height: {{ (day.messages / max_msgs * 100) if max_msgs > 0 else 0 }}%;"></div>
                    <span class="chart-label">{{ day.date[-5:] }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <div class="stats-tables">
        <div class="card">
            <div class="card-header">
                <span class="card-title">Top Users</span>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>User</th>
                            <th>Messages</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user_id, data in stats.top_users %}
                        <tr>
                            <td><span class="rank">{{ loop.index }}</span></td>
                            <td>{{ data.name }}</td>
                            <td>{{ data.messages }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="3" class="empty-cell">No data</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="card-title">Top Channels</span>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Channel</th>
                            <th>Messages</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for channel_id, data in stats.top_channels %}
                        <tr>
                            <td><span class="rank">{{ loop.index }}</span></td>
                            <td>#{{ data.name }}</td>
                            <td>{{ data.messages }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="3" class="empty-cell">No data</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Context Tab -->
<div id="tab-context" class="tab-content">
    <p class="context-intro">See what was sent to the LLM on the last API call for each bot.</p>

    {% if contexts %}
    {% for bot_name, ctx in contexts.items() %}
    <div class="card">
        <div class="card-header">
            <span class="card-title">{{ bot_name }}</span>
            <div class="context-meta">
                <span>{{ ctx.message_count }} messages</span>
                <span>~{{ ctx.token_estimate }} tokens</span>
            </div>
        </div>
        <div class="card-body">
            <div class="context-section">
                <h4 class="context-section-title">System Prompt</h4>
                <pre class="context-box">{{ ctx.system_prompt }}</pre>
            </div>
            <div class="context-section">
                <h4 class="context-section-title">Messages ({{ ctx.messages|length }})</h4>
                <div class="messages-list">
                    {% for msg in ctx.messages[-15:] %}
                    <div class="message {% if msg.role == 'assistant' %}assistant{% endif %}">
                        <span class="message-role">{{ msg.role }}</span>
                        <span class="message-content">{{ msg.content[:400] }}{% if msg.content|length > 400 %}...{% endif %}</span>
                    </div>
                    {% endfor %}
                    {% if ctx.messages|length > 15 %}
                    <div class="messages-more">... and {{ ctx.messages|length - 15 }} more</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="card">
        <div class="card-body">
            <div class="empty">No context stored yet. Make a request to see what's sent to the LLM.</div>
        </div>
    </div>
    {% endif %}
</div>

<style>
/* Page Header */
.page-header {
    margin-bottom: 32px;
}

.page-title {
    font-size: 1.875rem;
    font-weight: 600;
    letter-spacing: -0.025em;
    margin-bottom: 4px;
}

.page-subtitle {
    color: var(--text-muted);
    font-size: 0.875rem;
}

/* Tabs */
.tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 24px;
    border-bottom: 1px solid var(--border-subtle);
    padding-bottom: 0;
}

.tab {
    padding: 10px 20px;
    background: transparent;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    font-family: inherit;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: all 0.15s ease;
}

.tab:hover {
    color: var(--text-secondary);
}

.tab.active {
    color: var(--text-primary);
    border-bottom-color: var(--accent);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* Logs Controls */
.logs-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-subtle);
}

.logs-controls input,
.logs-controls select {
    padding: 8px 12px;
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-primary);
    font-family: inherit;
    font-size: 0.8125rem;
}

.logs-controls input {
    width: 160px;
}

.logs-controls input:focus,
.logs-controls select:focus {
    outline: none;
    border-color: var(--accent);
}

.log-count {
    color: var(--text-muted);
    font-size: 0.8125rem;
    margin-left: auto;
}

.auto-scroll-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: var(--text-muted);
    font-size: 0.8125rem;
    cursor: pointer;
    padding: 6px 12px;
    border-radius: 6px;
    transition: all 0.15s ease;
}

.auto-scroll-indicator:hover {
    background: var(--bg-tertiary);
}

.auto-scroll-indicator.active {
    color: var(--success);
}

.scroll-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: currentColor;
}

.auto-scroll-indicator.active .scroll-dot {
    animation: pulse-dot 1.5s infinite;
}

@keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}

/* Logs Container */
.logs-container {
    height: 500px;
    overflow-y: auto;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
    font-size: 0.8125rem;
}

.logs-empty {
    text-align: center;
    color: var(--text-muted);
    padding: 40px 20px;
}

.log-entry {
    display: flex;
    gap: 12px;
    padding: 8px 20px;
    border-bottom: 1px solid var(--border-subtle);
    transition: background 0.1s ease;
}

.log-entry:hover {
    background: var(--bg-primary);
}

.log-entry:last-child {
    border-bottom: none;
}

.log-time {
    color: var(--text-muted);
    flex-shrink: 0;
    font-size: 0.75rem;
}

.log-icon {
    flex-shrink: 0;
    width: 16px;
    text-align: center;
}

.log-bot {
    color: var(--accent);
    flex-shrink: 0;
    min-width: 80px;
    font-weight: 500;
}

.log-message {
    flex: 1;
    word-break: break-word;
    color: var(--text-secondary);
}

.log-ok .log-icon { color: var(--success); }
.log-warn .log-icon { color: var(--warning); }
.log-error .log-icon { color: var(--danger); }
.log-info .log-icon { color: var(--accent); }

/* Stats */
.stats-since {
    color: var(--text-muted);
    font-size: 0.8125rem;
    margin-bottom: 20px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
}

.stat-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: -0.025em;
}

.stat-label {
    color: var(--text-muted);
    font-size: 0.75rem;
    margin-top: 4px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* Chart */
.chart-bars {
    display: flex;
    align-items: flex-end;
    gap: 12px;
    height: 140px;
    padding-top: 24px;
    padding-bottom: 32px;
}

.chart-bar-wrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
    position: relative;
}

.chart-bar {
    width: 100%;
    background: var(--accent);
    border-radius: 4px 4px 0 0;
    min-height: 4px;
    margin-top: auto;
}

.chart-value {
    position: absolute;
    top: 0;
    font-size: 0.6875rem;
    color: var(--text-secondary);
    font-weight: 500;
}

.chart-label {
    position: absolute;
    bottom: -24px;
    font-size: 0.6875rem;
    color: var(--text-muted);
}

/* Stats Tables */
.stats-tables {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.rank {
    color: var(--accent);
    font-weight: 600;
}

.empty-cell {
    text-align: center;
    color: var(--text-muted);
    padding: 20px;
}

/* Context */
.context-intro {
    color: var(--text-muted);
    font-size: 0.875rem;
    margin-bottom: 20px;
}

.context-meta {
    display: flex;
    gap: 16px;
    font-size: 0.75rem;
    color: var(--text-muted);
}

.context-section {
    margin-bottom: 20px;
}

.context-section:last-child {
    margin-bottom: 0;
}

.context-section-title {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 10px;
}

.context-box {
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: 8px;
    padding: 16px;
    max-height: 200px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-size: 0.8125rem;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
    color: var(--text-secondary);
    margin: 0;
}

.messages-list {
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: 8px;
    max-height: 300px;
    overflow-y: auto;
}

.message {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border-subtle);
    font-size: 0.8125rem;
}

.message:last-child {
    border-bottom: none;
}

.message.assistant {
    background: rgba(59, 130, 246, 0.05);
}

.message-role {
    color: var(--accent);
    font-weight: 600;
    margin-right: 8px;
    text-transform: capitalize;
}

.message-content {
    color: var(--text-secondary);
}

.messages-more {
    color: var(--text-muted);
    text-align: center;
    padding: 10px;
    font-size: 0.75rem;
}

/* Button sizes */
.btn-sm {
    padding: 6px 12px;
    font-size: 0.8125rem;
}

/* Responsive */
@media (max-width: 768px) {
    .tabs {
        flex-wrap: wrap;
    }

    .tab {
        padding: 8px 14px;
        font-size: 0.8125rem;
    }

    .logs-controls {
        gap: 8px;
    }

    .logs-controls input,
    .logs-controls select {
        width: 100%;
    }

    .log-count {
        margin-left: 0;
        width: 100%;
    }

    .log-time {
        display: none;
    }

    .log-bot {
        min-width: 60px;
        font-size: 0.75rem;
    }

    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .stats-tables {
        grid-template-columns: 1fr;
    }

    .context-meta {
        flex-direction: column;
        gap: 4px;
    }
}
</style>

<script>
function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
    document.getElementById('tab-' + tabName).classList.add('active');
}

let autoScroll = true;
let lastLogCount = 0;
let allLogs = [];

function filterLogs() {
    const search = document.getElementById('log-search').value.toLowerCase();
    const level = document.getElementById('log-level-filter').value;
    const filtered = allLogs.filter(log => {
        const matchesSearch = !search || log.message.toLowerCase().includes(search) || (log.bot && log.bot.toLowerCase().includes(search));
        const matchesLevel = !level || log.level === level;
        return matchesSearch && matchesLevel;
    });
    renderFilteredLogs(filtered);
}

function renderFilteredLogs(logs) {
    const container = document.getElementById('logs-container');
    if (logs.length === 0) {
        container.innerHTML = '<div class="logs-empty">No matching logs</div>';
        updateLogCount(0);
        return;
    }
    let html = '';
    for (const log of logs) {
        const bot = log.bot ? `[${log.bot}]` : '';
        html += `<div class="log-entry log-${escapeHtml(log.level)}">
            <span class="log-time">${escapeHtml(log.time)}</span>
            <span class="log-icon">${log.icon}</span>
            <span class="log-bot">${escapeHtml(bot)}</span>
            <span class="log-message">${escapeHtml(log.message)}</span>
        </div>`;
    }
    container.innerHTML = html;
    updateLogCount(logs.length);
    if (autoScroll) container.scrollTop = container.scrollHeight;
}

function toggleAutoScroll() {
    autoScroll = !autoScroll;
    document.getElementById('auto-scroll-btn').textContent = autoScroll ? 'Pause' : 'Resume';
    document.getElementById('scroll-indicator').className = 'auto-scroll-indicator' + (autoScroll ? ' active' : '');
}

function clearLogs() {
    fetch('/api/logs/clear', {
        method: 'POST',
        headers: { 'X-CSRF-Token': '{{ csrf_token() }}' }
    }).catch(e => console.error('Failed to clear server logs:', e));
    document.getElementById('logs-container').innerHTML = '<div class="logs-empty">Logs cleared</div>';
    lastLogCount = 0;
    allLogs = [];
    updateLogCount(0);
}

function updateLogCount(count) {
    document.getElementById('log-count').textContent = count + ' entries';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function fetchLogs() {
    try {
        const response = await fetch('/api/logs');
        const logs = await response.json();
        if (logs.length !== lastLogCount) {
            allLogs = logs;
            lastLogCount = logs.length;
            filterLogs();
        }
    } catch (err) {
        console.error('Failed to fetch logs:', err);
    }
}

fetchLogs();
let logsPollInterval = setInterval(fetchLogs, 2000);

// Pause polling when tab is hidden
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        clearInterval(logsPollInterval);
    } else {
        fetchLogs();
        logsPollInterval = setInterval(fetchLogs, 2000);
    }
});
</script>
{% endblock %}
