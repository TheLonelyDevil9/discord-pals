{% extends "base.html" %}
{% block title %}Memories - Discord Pals{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Memories</h1>
    <p class="page-subtitle">Manage bot memories and server lore</p>
</div>

<!-- Tab Navigation -->
<div class="tabs">
    <button type="button" class="tab active" onclick="switchTab('files')">Memory Files</button>
    <button type="button" class="tab" onclick="switchTab('add')">Add Memory</button>
    <button type="button" class="tab" onclick="switchTab('lore')">Server Lore</button>
</div>

<!-- Memory Files Tab -->
<div id="tab-files" class="tab-content active">
    {% if memories %}
    {% for file_name, data in memories.items() %}
    <div class="card memory-file-card">
        <div class="card-header">
            <span class="card-title">{{ file_name }}</span>
            <a href="/memories/{{ file_name }}/edit" class="btn btn-ghost">Edit Raw JSON</a>
        </div>

        {% if data.error %}
        <div class="card-body">
            <div class="empty">Error: {{ data.error }}</div>
        </div>
        {% elif data %}
        <div class="table-responsive">
            <table class="memories-table">
                <thead>
                    <tr>
                        <th class="col-checkbox">
                            <input type="checkbox" id="select-all-{{ file_name }}" onchange="toggleSelectAll('{{ file_name }}')" title="Select all">
                        </th>
                        <th class="col-key">Key / Type</th>
                        <th class="col-content">Content</th>
                        <th class="col-action">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in data.items() %}
                    <tr>
                        <td>
                            <input type="checkbox" class="memory-checkbox" data-file="{{ file_name }}" data-key="{{ key }}" title="Select this memory">
                        </td>
                        <td>
                            <code>{{ key }}</code>
                            {% if key in user_names %}
                            <div class="user-name-hint">{{ user_names[key] }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {% if value is string %}
                            <span class="memory-text">{{ value[:200] }}{% if value|length > 200 %}...{% endif %}</span>
                            {% else %}
                            <pre class="memory-content">{{ value | tojson(indent=2) }}</pre>
                            {% endif %}
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger" onclick="confirmDeleteMemory('{{ file_name }}', '{{ key }}')">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="card-body bulk-actions">
            <button type="button" class="btn btn-danger" onclick="deleteSelectedMemories('{{ file_name }}')">Delete Selected</button>
            <button type="button" class="btn btn-danger" onclick="clearAllMemories('{{ file_name }}')">Clear All</button>
        </div>
        {% else %}
        <div class="card-body">
            <div class="empty">No memories stored</div>
        </div>
        {% endif %}
    </div>
    {% endfor %}
    {% else %}
    <div class="card">
        <div class="empty">No memory files found in <code>bot_data/</code></div>
    </div>
    {% endif %}
</div>

<!-- Add Memory Tab -->
<div id="tab-add" class="tab-content">
    <div class="card">
        <div class="card-header">
            <span class="card-title">Add New Memory</span>
        </div>
        <div class="card-body">
            <p class="tab-description">Manually add memories that the bot will remember about servers or users.</p>

            <div class="form-row">
                <div class="form-group">
                    <label for="memory-type">Memory Type</label>
                    <select id="memory-type" onchange="updateMemoryForm()" title="Select memory type">
                        <option value="server">Server Memory (shared)</option>
                        <option value="lore">Server Lore (world-building)</option>
                        <option value="global">Global User Profile (cross-server)</option>
                    </select>
                </div>
                <div class="form-group" id="guild-select-group">
                    <label for="memory-guild">Server</label>
                    <select id="memory-guild" title="Select a server">
                        <option value="">Select a server...</option>
                        {% for guild in guilds %}
                        <option value="{{ guild.id }}">{{ guild.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-row hidden" id="user-id-row">
                <div class="form-group">
                    <label for="memory-user-id">User ID</label>
                    <input type="text" id="memory-user-id" placeholder="Discord User ID">
                </div>
            </div>

            <div class="form-group">
                <label for="memory-content">Memory Content</label>
                <textarea id="memory-content" placeholder="Enter the memory content..." title="Memory content"></textarea>
            </div>

            <button type="button" class="btn btn-primary" onclick="addMemory()">Save Memory</button>
        </div>
    </div>
</div>

<!-- Lore Tab -->
<div id="tab-lore" class="tab-content">
    <div class="card">
        <div class="card-header">
            <span class="card-title">Server Lore Management</span>
        </div>
        <div class="card-body">
            <p class="tab-description">Lore is world-building information that helps the bot understand the context of your server.</p>

            {% if guilds %}
            <div class="form-group">
                <label for="lore-guild">Select Server</label>
                <select id="lore-guild" onchange="loadLore()" title="Select a server">
                    <option value="">Select a server...</option>
                    {% for guild in guilds %}
                    <option value="{{ guild.id }}" data-lore="{{ guild.lore | e }}">{{ guild.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="lore-editor" class="hidden">
                <div class="form-group">
                    <label for="lore-content">Current Lore</label>
                    <textarea id="lore-content" placeholder="No lore set for this server..." title="Server lore content"></textarea>
                </div>

                <div class="lore-actions">
                    <button type="button" class="btn btn-primary" onclick="saveLore(false)">Append Lore</button>
                    <button type="button" class="btn btn-ghost" onclick="saveLore(true)">Replace Lore</button>
                    <button type="button" class="btn btn-danger" onclick="clearLore()">Clear Lore</button>
                </div>
            </div>
            {% else %}
            <div class="empty">No servers available. Make sure your bots are online.</div>
            {% endif %}
        </div>
    </div>
</div>

<style>
/* Page Header */
.page-header {
    margin-bottom: 32px;
}

.page-title {
    font-size: 1.875rem;
    font-weight: 600;
    letter-spacing: -0.025em;
    margin-bottom: 4px;
}

.page-subtitle {
    color: var(--text-muted);
    font-size: 0.875rem;
}

.tab-description {
    color: var(--text-muted);
    font-size: 0.875rem;
    margin-bottom: 20px;
}

/* Memory File Card */
.memory-file-card {
    margin-bottom: 20px;
}

/* Memories Table */
.memories-table {
    table-layout: fixed;
}

.memories-table .col-checkbox {
    width: 48px;
}

.memories-table .col-key {
    width: 180px;
}

.memories-table .col-action {
    width: 100px;
}

.memories-table td {
    vertical-align: top;
}

.user-name-hint {
    color: var(--accent);
    font-size: 0.75rem;
    margin-top: 4px;
}

.memory-text {
    color: var(--text-secondary);
    font-size: 0.8125rem;
}

.memory-content {
    max-height: 150px;
    overflow: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 0.75rem;
    background: var(--bg-primary);
    padding: 8px;
    border-radius: 6px;
    border: 1px solid var(--border-subtle);
    margin: 0;
}

/* Bulk Actions */
.bulk-actions {
    display: flex;
    gap: 12px;
    border-top: 1px solid var(--border-subtle);
}

/* Form Layout */
.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 16px;
}

.form-group textarea {
    min-height: 120px;
}

/* Lore Actions */
.lore-actions {
    display: flex;
    gap: 12px;
    margin-top: 16px;
}

/* Utility */
.hidden {
    display: none !important;
}

/* Responsive */
@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }

    .bulk-actions {
        flex-direction: column;
    }

    .lore-actions {
        flex-direction: column;
    }

    .memories-table .col-key {
        width: 120px;
    }
}
</style>

<script>
// Tab switching
function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

    document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
    document.getElementById('tab-' + tabName).classList.add('active');
}

// Update memory form based on type
function updateMemoryForm() {
    const type = document.getElementById('memory-type').value;
    const userIdRow = document.getElementById('user-id-row');
    const guildSelect = document.getElementById('guild-select-group');

    if (type === 'global') {
        userIdRow.classList.remove('hidden');
        guildSelect.classList.add('hidden');
    } else {
        userIdRow.classList.add('hidden');
        guildSelect.classList.remove('hidden');
    }
}

// Add memory
async function addMemory() {
    const type = document.getElementById('memory-type').value;
    const guildId = document.getElementById('memory-guild').value;
    const userId = document.getElementById('memory-user-id').value;
    const content = document.getElementById('memory-content').value.trim();

    if (!content) {
        showToast('Please enter memory content', 'error');
        return;
    }

    if ((type === 'server' || type === 'lore') && !guildId) {
        showToast('Please select a server', 'error');
        return;
    }

    if (type === 'global' && !userId) {
        showToast('Please enter a user ID', 'error');
        return;
    }

    try {
        const response = await fetch('/api/memories/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                type: type,
                guild_id: guildId,
                user_id: userId,
                content: content
            })
        });

        const data = await response.json();

        if (data.status === 'ok') {
            showToast('Memory saved successfully!', 'success');
            document.getElementById('memory-content').value = '';
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'Failed to save memory', 'error');
        }
    } catch (e) {
        showToast('Error saving memory', 'error');
    }
}

// Load lore for selected guild
function loadLore() {
    const select = document.getElementById('lore-guild');
    const editor = document.getElementById('lore-editor');
    const textarea = document.getElementById('lore-content');

    if (!select.value) {
        editor.classList.add('hidden');
        return;
    }

    const option = select.options[select.selectedIndex];
    const lore = option.dataset.lore || '';

    textarea.value = lore;
    editor.classList.remove('hidden');
}

// Save lore
async function saveLore(replace) {
    const guildId = document.getElementById('lore-guild').value;
    const content = document.getElementById('lore-content').value.trim();

    if (!guildId) {
        showToast('Please select a server', 'error');
        return;
    }

    if (!content && !replace) {
        showToast('Please enter lore content', 'error');
        return;
    }

    try {
        const response = await fetch(`/api/lore/${guildId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                content: content,
                replace: replace
            })
        });

        const data = await response.json();

        if (data.status === 'ok') {
            showToast(replace ? 'Lore replaced!' : 'Lore appended!', 'success');
            const option = document.querySelector(`#lore-guild option[value="${guildId}"]`);
            if (option) {
                option.dataset.lore = replace ? content : (option.dataset.lore || '') + '\n' + content;
            }
        } else {
            showToast('Failed to save lore', 'error');
        }
    } catch (e) {
        showToast('Error saving lore', 'error');
    }
}

// Clear lore
function clearLore() {
    const guildId = document.getElementById('lore-guild').value;

    if (!guildId) {
        showToast('Please select a server', 'error');
        return;
    }

    showConfirm('Clear Lore', 'Are you sure you want to clear all lore for this server?', async () => {
        try {
            const response = await fetch(`/api/lore/${guildId}`, {
                method: 'DELETE',
                headers: { 'X-CSRF-Token': '{{ csrf_token() }}' }
            });

            const data = await response.json();

            if (data.status === 'ok') {
                showToast('Lore cleared!', 'success');
                document.getElementById('lore-content').value = '';
                const option = document.querySelector(`#lore-guild option[value="${guildId}"]`);
                if (option) option.dataset.lore = '';
            } else {
                showToast('Failed to clear lore', 'error');
            }
        } catch (e) {
            showToast('Error clearing lore', 'error');
        }
    });
}

// Delete memory confirmation
function confirmDeleteMemory(fileName, key) {
    showConfirm('Delete Memory', 'Are you sure you want to delete this memory entry?', function() {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/memories/' + fileName + '/delete';
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = '{{ csrf_token() }}';
        form.appendChild(csrfInput);
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'key';
        input.value = key;
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    });
}

// Toggle select all checkboxes
function toggleSelectAll(fileName) {
    const selectAllCheckbox = document.getElementById(`select-all-${fileName}`);
    const checkboxes = document.querySelectorAll(`.memory-checkbox[data-file="${fileName}"]`);
    checkboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
}

// Get selected memory keys
function getSelectedMemories(fileName) {
    const checkboxes = document.querySelectorAll(`.memory-checkbox[data-file="${fileName}"]:checked`);
    return Array.from(checkboxes).map(cb => cb.dataset.key);
}

// Delete selected memories
async function deleteSelectedMemories(fileName) {
    const selectedKeys = getSelectedMemories(fileName);

    if (selectedKeys.length === 0) {
        showToast('No memories selected', 'error');
        return;
    }

    showConfirm(
        'Delete Selected Memories',
        `Are you sure you want to delete ${selectedKeys.length} selected memor${selectedKeys.length === 1 ? 'y' : 'ies'}?`,
        async function() {
            try {
                const response = await fetch(`/api/memories/${fileName}/delete-selected`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({ keys: selectedKeys })
                });

                const data = await response.json();

                if (data.status === 'ok') {
                    showToast(`Deleted ${selectedKeys.length} memor${selectedKeys.length === 1 ? 'y' : 'ies'}!`, 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.message || 'Failed to delete memories', 'error');
                }
            } catch (e) {
                showToast('Error deleting memories', 'error');
            }
        }
    );
}

// Clear all memories
function clearAllMemories(fileName) {
    showConfirm(
        'Clear All Memories',
        `This will permanently delete ALL memories in ${fileName}. This action cannot be undone. Are you sure?`,
        async function() {
            try {
                const response = await fetch(`/api/memories/${fileName}/clear-all`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': '{{ csrf_token() }}'
                    }
                });

                const data = await response.json();

                if (data.status === 'ok') {
                    showToast('All memories cleared!', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.message || 'Failed to clear memories', 'error');
                }
            } catch (e) {
                showToast('Error clearing memories', 'error');
            }
        }
    );
}
</script>
{% endblock %}
