{% extends "base.html" %}
{% block title %}Dashboard - Discord Pals{% endblock %}

{% block content %}
<h1 style="margin-bottom: 30px;">Dashboard</h1>

<!-- Killswitch Banner (shown when active) -->
<div id="killswitch-banner" class="killswitch-banner {% if not global_paused %}hidden{% endif %}">
    <span class="banner-icon">üõë</span>
    <span class="banner-text">KILLSWITCH ACTIVE - All bot responses are paused</span>
    <button class="btn btn-secondary" onclick="toggleKillswitch()">Release</button>
</div>

<!-- Control Panel -->
<div class="card control-panel">
    <h3 class="card-title">üéõÔ∏è Control Panel</h3>
    <div class="controls-grid">
        <div class="control-item" id="killswitch-control">
            <div class="control-label">
                <span class="control-icon">üõë</span>
                <div>
                    <strong>Global Killswitch</strong>
                    <small>Stops ALL bot responses</small>
                </div>
            </div>
            <button id="killswitch-btn" class="btn toggle-btn {% if global_paused %}active danger{% else %}inactive{% endif %}" onclick="toggleKillswitch()">
                <span class="toggle-status">{{ 'ACTIVE' if global_paused else 'INACTIVE' }}</span>
            </button>
        </div>
        <div class="control-item">
            <div class="control-label">
                <span class="control-icon">ü§ñ</span>
                <div>
                    <strong>Bot-to-Bot Chat</strong>
                    <small>Allow bots to respond to each other</small>
                </div>
            </div>
            <button id="bot-interactions-btn" class="btn toggle-btn {% if bot_interactions_paused %}inactive{% else %}active success{% endif %}" onclick="toggleBotInteractions()">
                <span class="toggle-status">{{ 'PAUSED' if bot_interactions_paused else 'ENABLED' }}</span>
            </button>
        </div>
        <div class="control-item">
            <div class="control-label">
                <span class="control-icon">üìù</span>
                <div>
                    <strong>Message Format</strong>
                    <small>How messages are sent to LLM</small>
                </div>
            </div>
            <button id="message-format-btn" class="btn toggle-btn {% if use_single_user %}active info{% else %}inactive{% endif %}" onclick="toggleMessageFormat()">
                <span class="toggle-status">{{ 'SINGLE-USER' if use_single_user else 'MULTI-ROLE' }}</span>
            </button>
        </div>
        <div class="control-item">
            <div class="control-label">
                <span class="control-icon">üîÑ</span>
                <div>
                    <strong>Restart Bot</strong>
                    <small>Restart without terminal</small>
                </div>
            </div>
            <button id="restart-btn" class="btn toggle-btn restart-btn" onclick="restartBot()">
                <span class="toggle-status">RESTART</span>
            </button>
        </div>
    </div>
    <div class="control-help">
        <details open>
            <summary>‚ÑπÔ∏è Message Format Help</summary>
            <div class="format-disclaimer">
                <p><strong>üîÄ Multi-Role (Default - Recommended):</strong> Uses traditional system/user/assistant roles. This is the standard OpenAI-compatible format that most LLM APIs expect. Each message has a proper role designation.</p>
                <p><strong>üìù Single-User (SillyTavern-style):</strong> All messages combined into one user message with [Author]: prefixes. Use this only if your LLM provider has issues with multi-role format or you're using a model that works better with combined context.</p>
                <div class="format-warning">
                    <span>‚ö†Ô∏è</span> Single-User mode is provided for compatibility. Most users should keep Multi-Role enabled for best results with modern LLM APIs.
                </div>
            </div>
        </details>
    </div>
</div>

<div class="grid">
    <div class="card stat">
        <div class="stat-value">{{ bots|length }}</div>
        <div class="stat-label">Active Bot(s)</div>
    </div>
    <div class="card stat">
        <div class="stat-value">{{ memory_count }}</div>
        <div class="stat-label">Memory Files</div>
    </div>
    <div class="card stat">
        <div class="stat-value">{{ character_count }}</div>
        <div class="stat-label">Characters</div>
    </div>
    <div class="card stat">
        <div class="stat-value">{{ autonomous_count }}</div>
        <div class="stat-label">Autonomous Channels</div>
    </div>
</div>

<div class="card">
    <h3 class="card-title">Bot Status <span id="refresh-indicator" style="font-size: 0.7em; color: var(--text-muted);">‚óè Live</span></h3>
    {% if bots %}
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Character</th>
                <th>Status</th>
                <th>Last Activity</th>
            </tr>
        </thead>
        <tbody id="bot-status-table">
            {% for bot in bots %}
            <tr>
                <td><strong>{{ bot.name }}</strong></td>
                <td>{{ bot.character }}</td>
                <td>
                    {% if bot.online %}
                    <span class="badge badge-success">‚óè Online</span>
                    {% else %}
                    <span class="badge badge-danger">‚óè Offline</span>
                    {% endif %}
                </td>
                <td style="color: var(--text-muted);">{{ bot.last_activity }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty">No bots running</div>
    {% endif %}
</div>

<style>
/* Killswitch Banner */
.killswitch-banner {
    background: linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%);
    color: white;
padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    animation: banner-pulse 1.5s infinite;
}

.killswitch-banner.hidden {
    display: none;
}

.banner-icon {
    font-size: 1.5em;
}

.banner-text {
    flex: 1;
    font-weight: bold;
    font-size: 1.1em;
}

@keyframes banner-pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(248, 81, 73, 0.5); }
    50% { box-shadow: 0 0 20px 5px rgba(248, 81, 73, 0.3); }
}

.control-panel {
    background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(88, 166, 255, 0.05) 100%);
    border: 1px solid var(--accent);
}

.controls-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.control-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: var(--bg);
    border-radius: 8px;
    border: 1px solid var(--border);
    transition: border-color 0.3s ease;
}

.control-item.killswitch-active {
    border-color: var(--danger);
    background: rgba(248, 81, 73, 0.1);
}

.control-label {
    display: flex;
    align-items: center;
    gap: 12px;
}

.control-icon {
    font-size: 1.5em;
}

.control-label small {
    display: block;
    color: var(--text-muted);
    font-size: 0.85em;
}

.control-help {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid var(--border);
}

.control-help details {
    color: var(--text-muted);
    font-size: 0.9em;
}

.control-help summary {
    cursor: pointer;
    color: var(--accent);
}

.control-help p {
    margin: 8px 0 8px 20px;
}

.toggle-btn {
    min-width: 120px;
    padding: 10px 20px;
    font-weight: bold;
    text-transform: uppercase;
    font-size: 0.85em;
    transition: all 0.3s ease;
    position: relative;
}

.toggle-btn:disabled {
    opacity: 0.6;
    cursor: wait;
}

.toggle-btn.active.danger {
    background: var(--danger);
    color: white;
    animation: pulse-danger 2s infinite;
}

.toggle-btn.active.success {
    background: var(--success);
    color: white;
}

.toggle-btn.active.info {
    background: var(--accent);
    color: #0d1117;
}

.toggle-btn.inactive {
    background: var(--border);
    color: var(--text-muted);
}

/* Confirmation flash effect */
.toggle-btn.confirmed {
    animation: confirm-flash 0.5s ease;
}

@keyframes confirm-flash {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

@keyframes pulse-danger {
    0%, 100% { box-shadow: 0 0 0 0 rgba(248, 81, 73, 0.4); }
    50% { box-shadow: 0 0 0 10px rgba(248, 81, 73, 0); }
}

#refresh-indicator {
    animation: blink 2s infinite;
}

@keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

/* Format disclaimer styles */
.format-disclaimer {
    padding: 10px 0;
}

.format-disclaimer p {
    margin: 10px 0 10px 20px;
    line-height: 1.5;
}

.format-warning {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    margin: 15px 0 5px 20px;
    padding: 12px 15px;
    background: rgba(210, 153, 34, 0.15);
    border: 1px solid var(--warning);
    border-radius: 6px;
    color: var(--warning);
    font-size: 0.9em;
}

.format-warning span {
    font-size: 1.2em;
}

/* Restart button styles */
.restart-btn {
    background: linear-gradient(135deg, var(--warning) 0%, #b45309 100%);
    color: #0d1117;
}

.restart-btn:hover {
    opacity: 0.9;
}

.restart-btn.restarting {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>

<script>
// Toggle killswitch with verification
async function toggleKillswitch() {
    const btn = document.getElementById('killswitch-btn');
    const banner = document.getElementById('killswitch-banner');
    const control = document.getElementById('killswitch-control');
    
    btn.disabled = true;
    btn.querySelector('.toggle-status').textContent = '...';
    
    try {
        const response = await fetch('/api/killswitch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        const data = await response.json();
        
        if (data.status === 'ok') {
            // Verify the state was actually changed by fetching current state
            const verifyResponse = await fetch('/api/killswitch');
            const verifyData = await verifyResponse.json();
            
            // Use verified state
            const confirmedState = verifyData.global_paused;
            updateKillswitchUI(confirmedState);
            
            // Add confirmation flash
            btn.classList.add('confirmed');
            setTimeout(() => btn.classList.remove('confirmed'), 500);
            
            // Show prominent feedback
            if (confirmedState) {
                showToast('‚úÖ KILLSWITCH CONFIRMED ACTIVE - All bot responses are now paused', 'warning');
            } else {
                showToast('‚úÖ KILLSWITCH CONFIRMED OFF - Bots are now responding normally', 'success');
            }
        } else {
            showToast('‚ö†Ô∏è Killswitch toggle failed - please try again', 'error');
        }
    } catch (e) {
        showToast('‚ùå Failed to toggle killswitch - check connection', 'error');
        console.error('Killswitch error:', e);
    }
    
    btn.disabled = false;
}

// Toggle bot-to-bot interactions
async function toggleBotInteractions() {
    const btn = document.getElementById('bot-interactions-btn');
    btn.disabled = true;
    btn.querySelector('.toggle-status').textContent = '...';
    
    try {
        const response = await fetch('/api/bot-interactions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        const data = await response.json();
        
        if (data.status === 'ok') {
            updateBotInteractionsUI(data.bot_interactions_paused);
            btn.classList.add('confirmed');
            setTimeout(() => btn.classList.remove('confirmed'), 500);
            showToast(data.bot_interactions_paused ? '‚úÖ Bot-to-bot chat PAUSED' : '‚úÖ Bot-to-bot chat ENABLED', 'success');
        }
    } catch (e) {
        showToast('Failed to toggle bot interactions', 'error');
    }
    
    btn.disabled = false;
}

// Toggle message format
async function toggleMessageFormat() {
    const btn = document.getElementById('message-format-btn');
    btn.disabled = true;
    btn.querySelector('.toggle-status').textContent = '...';
    
    try {
        const response = await fetch('/api/message-format', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        const data = await response.json();
        
        if (data.status === 'ok') {
            updateMessageFormatUI(data.use_single_user);
            btn.classList.add('confirmed');
            setTimeout(() => btn.classList.remove('confirmed'), 500);
            showToast(data.use_single_user
                ? '‚úÖ Message format: SINGLE-USER (SillyTavern-style)'
                : '‚úÖ Message format: MULTI-ROLE (system/user/assistant)', 'success');
        }
    } catch (e) {
        showToast('Failed to toggle message format', 'error');
    }
    
    btn.disabled = false;
}

// Update UI for killswitch state
function updateKillswitchUI(isPaused) {
    const btn = document.getElementById('killswitch-btn');
    const banner = document.getElementById('killswitch-banner');
    const control = document.getElementById('killswitch-control');
    const status = btn.querySelector('.toggle-status');
    
    if (isPaused) {
        btn.className = 'btn toggle-btn active danger';
        status.textContent = 'ACTIVE';
        banner.classList.remove('hidden');
        control.classList.add('killswitch-active');
    } else {
        btn.className = 'btn toggle-btn inactive';
        status.textContent = 'INACTIVE';
        banner.classList.add('hidden');
        control.classList.remove('killswitch-active');
    }
}

// Update UI for bot interactions state
function updateBotInteractionsUI(isPaused) {
    const btn = document.getElementById('bot-interactions-btn');
    const status = btn.querySelector('.toggle-status');
    
    if (isPaused) {
        btn.className = 'btn toggle-btn inactive';
        status.textContent = 'PAUSED';
    } else {
        btn.className = 'btn toggle-btn active success';
        status.textContent = 'ENABLED';
    }
}

// Update UI for message format state
function updateMessageFormatUI(isSingleUser) {
    const btn = document.getElementById('message-format-btn');
    const status = btn.querySelector('.toggle-status');
    
    if (isSingleUser) {
        btn.className = 'btn toggle-btn active info';
        status.textContent = 'SINGLE-USER';
    } else {
        btn.className = 'btn toggle-btn inactive';
        status.textContent = 'MULTI-ROLE';
    }
}

// Auto-refresh status every 5 seconds
async function refreshStatus() {
    try {
        const response = await fetch('/api/status');
        const data = await response.json();
        
        // Update control panel
        updateKillswitchUI(data.global_paused);
        updateBotInteractionsUI(data.bot_interactions_paused);
        if (data.use_single_user !== undefined) {
            updateMessageFormatUI(data.use_single_user);
        }
        
        // Update bot status table
        const table = document.getElementById('bot-status-table');
        if (table && data.bots) {
            table.innerHTML = data.bots.map(bot => `
                <tr>
                    <td><strong>${bot.name}</strong></td>
                    <td>${bot.character || 'None'}</td>
                    <td>
                        ${bot.online
                            ? '<span class="badge badge-success">‚óè Online</span>'
                            : '<span class="badge badge-danger">‚óè Offline</span>'}
                    </td>
                    <td style="color: var(--text-muted);">${bot.last_activity}</td>
                </tr>
            `).join('');
        }
        
        // Flash the indicator
        const indicator = document.getElementById('refresh-indicator');
        if (indicator) {
            indicator.style.color = 'var(--success)';
            setTimeout(() => { indicator.style.color = 'var(--text-muted)'; }, 500);
        }
    } catch (e) {
        console.error('Failed to refresh status:', e);
    }
}

// Start auto-refresh with visibility-based pause
let statusPollInterval = setInterval(refreshStatus, 5000);

document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        clearInterval(statusPollInterval);
    } else {
        refreshStatus();
        statusPollInterval = setInterval(refreshStatus, 5000);
    }
});

// Restart bot
async function restartBot() {
    const btn = document.getElementById('restart-btn');
    
    // Confirm restart
    if (!confirm('Are you sure you want to restart the bot? This will briefly disconnect all bots.')) {
        return;
    }
    
    btn.disabled = true;
    btn.querySelector('.toggle-status').textContent = 'RESTARTING...';
    btn.classList.add('restarting');
    
    try {
        const response = await fetch('/api/restart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        
        if (data.status === 'ok') {
            showToast('üîÑ Restart initiated. Page will reload in 5 seconds...', 'warning');
            
            // Wait and then reload the page
            setTimeout(() => {
                location.reload();
            }, 5000);
        } else {
            showToast('‚ùå Restart failed: ' + (data.message || 'Unknown error'), 'error');
            btn.disabled = false;
            btn.querySelector('.toggle-status').textContent = 'RESTART';
            btn.classList.remove('restarting');
        }
    } catch (e) {
        showToast('‚ùå Failed to restart - check connection', 'error');
        btn.disabled = false;
        btn.querySelector('.toggle-status').textContent = 'RESTART';
        btn.classList.remove('restarting');
    }
}
</script>
{% endblock %}
