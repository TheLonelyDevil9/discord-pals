{% extends "base.html" %}
{% block title %}Dashboard - Discord Pals{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Dashboard</h1>
    <p class="page-subtitle">Monitor and control your Discord bots</p>
</div>

<!-- Killswitch Banner (shown when active) -->
<div id="killswitch-banner" class="alert-banner {% if not global_paused %}hidden{% endif %}">
    <span class="alert-icon">‚ö†Ô∏è</span>
    <div class="alert-content">
        <div class="alert-title">Killswitch Active</div>
        <div class="alert-text">All bot responses are currently paused</div>
    </div>
    <button type="button" class="btn btn-ghost" onclick="toggleKillswitch()">Release</button>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="card stat-card">
        <div class="stat-label">Active Bots</div>
        <div class="stat-value">{{ bots|length }}</div>
    </div>
    <div class="card stat-card">
        <div class="stat-label">Memory Files</div>
        <div class="stat-value">{{ memory_count }}</div>
    </div>
    <div class="card stat-card">
        <div class="stat-label">Characters</div>
        <div class="stat-value">{{ character_count }}</div>
    </div>
    <div class="card stat-card">
        <div class="stat-label">Auto Channels</div>
        <div class="stat-value">{{ autonomous_count }}</div>
    </div>
</div>

<!-- Control Panel -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Control Panel</span>
    </div>
    <div class="card-body">
        <div class="controls-grid">
            <div class="control-item" id="killswitch-control">
                <div class="control-info">
                    <div class="control-icon">üõë</div>
                    <div>
                        <div class="control-label">Global Killswitch</div>
                        <div class="control-desc">Stops all bot responses</div>
          </div>
                </div>
                <button type="button" id="killswitch-btn" class="btn {% if global_paused %}btn-danger{% else %}btn-ghost{% endif %}" onclick="toggleKillswitch()">
                    <span class="toggle-status">{{ 'Active' if global_paused else 'Inactive' }}</span>
                </button>
            </div>
            <div class="control-item">
                <div class="control-info">
                    <div class="control-icon">ü§ñ</div>
                    <div>
                        <div class="control-label">Bot-to-Bot Chat</div>
                        <div class="control-desc">Allow bots to respond to each other</div>
                    </div>
                </div>
                <button type="button" id="bot-interactions-btn" class="btn {% if bot_interactions_paused %}btn-ghost{% else %}btn-success{% endif %}" onclick="toggleBotInteractions()">
                    <span class="toggle-status">{{ 'Paused' if bot_interactions_paused else 'Enabled' }}</span>
                </button>
            </div>
            <div class="control-item">
                <div class="control-info">
                    <div class="control-icon">üìù</div>
                    <div>
                        <div class="control-label">Message Format</div>
                        <div class="control-desc">How messages are sent to LLM</div>
                    </div>
                </div>
                <button type="button" id="message-format-btn" class="btn {% if use_single_user %}btn-primary{% else %}btn-ghost{% endif %}" onclick="toggleMessageFormat()">
                    <span class="toggle-status">{{ 'Single-User' if use_single_user else 'Multi-Role' }}</span>
                </button>
            </div>
            <div class="control-item">
                <div class="control-info">
                    <div class="control-icon">üîÑ</div>
                    <div>
                        <div class="control-label">Restart Bot</div>
                        <div class="control-desc">Restart without terminal</div>
                    </div>
                </div>
                <button type="button" id="restart-btn" class="btn btn-primary" onclick="restartBot()">
                    <span class="toggle-status">Restart</span>
                </button>
            </div>
        </div>

        <div class="control-help">
            <details>
                <summary>Message Format Help</summary>
                <div class="help-content">
                    <p><strong>Multi-Role (Default):</strong> Uses traditional system/user/assistant roles. This is the standard OpenAI-compatible format that most LLM APIs expect.</p>
                    <p><strong>Single-User:</strong> All messages combined into one user message with [Author]: prefixes. Use this only if your LLM provider has issues with multi-role format.</p>
                </div>
            </details>
        </div>
    </div>
</div>

<!-- Bot Status -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Bot Status</span>
        <div class="live-indicator">
            <span class="live-dot"></span>
            Live
        </div>
    </div>
    {% if bots %}
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Character</th>
                <th>Status</th>
                <th>Last Activity</th>
            </tr>
        </thead>
        <tbody id="bot-status-table">
            {% for bot in bots %}
            <tr>
                <td><strong>{{ bot.name }}</strong></td>
                <td style="color: var(--text-secondary);">{{ bot.character }}</td>
                <td>
                    {% if bot.online %}
                    <span class="badge badge-success"><span class="badge-dot"></span> Online</span>
                    {% else %}
                    <span class="badge badge-danger"><span class="badge-dot"></span> Offline</span>
                    {% endif %}
                </td>
                <td style="color: var(--text-muted);">{{ bot.last_activity }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty">No bots running</div>
    {% endif %}
</div>

<style>
/* Page Header */
.page-header {
    margin-bottom: 32px;
}

.page-title {
    font-size: 1.875rem;
    font-weight: 600;
    letter-spacing: -0.025em;
    margin-bottom: 4px;
}

.page-subtitle {
    color: var(--text-muted);
    font-size: 0.875rem;
}

/* Alert Banner */
.alert-banner {
    background: var(--danger-muted);
    border: 1px solid var(--danger);
    border-radius: 8px;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
}

.alert-banner.hidden {
    display: none;
}

.alert-icon {
    font-size: 1.25rem;
}

.alert-content {
    flex: 1;
}

.alert-title {
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--danger);
}

.alert-text {
    color: var(--text-secondary);
    font-size: 0.8125rem;
    margin-top: 2px;
}

/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
}

.stat-card {
    padding: 24px;
}

.stat-card .stat-label {
    color: var(--text-muted);
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.stat-card .stat-value {
    font-size: 2rem;
    font-weight: 600;
    margin-top: 8px;
    letter-spacing: -0.025em;
}

/* Control Panel */
.controls-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}

.control-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: var(--bg-primary);
    border-radius: 8px;
    border: 1px solid var(--border-subtle);
}

.control-info {
    display: flex;
    align-items: center;
    gap: 14px;
}

.control-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    background: var(--bg-tertiary);
}

.control-label {
    font-weight: 500;
    font-size: 0.875rem;
}

.control-desc {
    color: var(--text-muted);
    font-size: 0.75rem;
    margin-top: 2px;
}

.control-help {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border-subtle);
}

.control-help details {
    color: var(--text-muted);
    font-size: 0.8125rem;
}

.control-help summary {
    cursor: pointer;
    color: var(--text-secondary);
    font-weight: 500;
}

.control-help summary:hover {
    color: var(--text-primary);
}

.help-content {
    margin-top: 12px;
    padding-left: 16px;
}

.help-content p {
    margin-bottom: 8px;
    line-height: 1.6;
}

/* Responsive */
@media (max-width: 1024px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }

    .controls-grid {
        grid-template-columns: 1fr;
    }

    .alert-banner {
        flex-direction: column;
        text-align: center;
        gap: 12px;
    }
}
</style>

<script>
// Toggle killswitch with verification
async function toggleKillswitch() {
    const btn = document.getElementById('killswitch-btn');
    const banner = document.getElementById('killswitch-banner');
    const control = document.getElementById('killswitch-control');

    btn.disabled = true;
    btn.querySelector('.toggle-status').textContent = '...';

    try {
        const response = await fetch('/api/killswitch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        const data = await response.json();

        if (data.status === 'ok') {
            const verifyResponse = await fetch('/api/killswitch');
            const verifyData = await verifyResponse.json();
            const confirmedState = verifyData.global_paused;
            updateKillswitchUI(confirmedState);

            if (confirmedState) {
                showToast('Killswitch activated - All bot responses paused', 'warning');
            } else {
                showToast('Killswitch released - Bots responding normally', 'success');
            }
        } else {
            showToast('Killswitch toggle failed - please try again', 'error');
        }
    } catch (e) {
        showToast('Failed to toggle killswitch - check connection', 'error');
        console.error('Killswitch error:', e);
    }

    btn.disabled = false;
}

// Toggle bot-to-bot interactions
async function toggleBotInteractions() {
    const btn = document.getElementById('bot-interactions-btn');
    btn.disabled = true;
    btn.querySelector('.toggle-status').textContent = '...';

    try {
        const response = await fetch('/api/bot-interactions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        const data = await response.json();

        if (data.status === 'ok') {
            updateBotInteractionsUI(data.bot_interactions_paused);
            showToast(data.bot_interactions_paused ? 'Bot-to-bot chat paused' : 'Bot-to-bot chat enabled', 'success');
        }
    } catch (e) {
        showToast('Failed to toggle bot interactions', 'error');
    }

    btn.disabled = false;
}

// Toggle message format
async function toggleMessageFormat() {
    const btn = document.getElementById('message-format-btn');
    btn.disabled = true;
    btn.querySelector('.toggle-status').textContent = '...';

    try {
        const response = await fetch('/api/message-format', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        const data = await response.json();

        if (data.status === 'ok') {
            updateMessageFormatUI(data.use_single_user);
            showToast(data.use_single_user ? 'Message format: Single-User' : 'Message format: Multi-Role', 'success');
        }
    } catch (e) {
        showToast('Failed to toggle message format', 'error');
    }

    btn.disabled = false;
}

// Update UI for killswitch state
function updateKillswitchUI(isPaused) {
    const btn = document.getElementById('killswitch-btn');
    const banner = document.getElementById('killswitch-banner');
    const status = btn.querySelector('.toggle-status');

    if (isPaused) {
        btn.className = 'btn btn-danger';
        status.textContent = 'Active';
        banner.classList.remove('hidden');
    } else {
        btn.className = 'btn btn-ghost';
        status.textContent = 'Inactive';
        banner.classList.add('hidden');
    }
}

// Update UI for bot interactions state
function updateBotInteractionsUI(isPaused) {
    const btn = document.getElementById('bot-interactions-btn');
    const status = btn.querySelector('.toggle-status');

    if (isPaused) {
        btn.className = 'btn btn-ghost';
        status.textContent = 'Paused';
    } else {
        btn.className = 'btn btn-success';
        status.textContent = 'Enabled';
    }
}

// Update UI for message format state
function updateMessageFormatUI(isSingleUser) {
    const btn = document.getElementById('message-format-btn');
    const status = btn.querySelector('.toggle-status');

    if (isSingleUser) {
        btn.className = 'btn btn-primary';
        status.textContent = 'Single-User';
    } else {
        btn.className = 'btn btn-ghost';
        status.textContent = 'Multi-Role';
    }
}

// Auto-refresh status every 5 seconds
async function refreshStatus() {
    try {
        const response = await fetch('/api/status');
        const data = await response.json();

        updateKillswitchUI(data.global_paused);
        updateBotInteractionsUI(data.bot_interactions_paused);
        if (data.use_single_user !== undefined) {
            updateMessageFormatUI(data.use_single_user);
        }

        const table = document.getElementById('bot-status-table');
        if (table && data.bots) {
            table.innerHTML = data.bots.map(bot => `
                <tr>
                    <td><strong>${bot.name}</strong></td>
                    <td style="color: var(--text-secondary);">${bot.character || 'None'}</td>
                    <td>
                        ${bot.online
                            ? '<span class="badge badge-success"><span class="badge-dot"></span> Online</span>'
                            : '<span class="badge badge-danger"><span class="badge-dot"></span> Offline</span>'}
                    </td>
                    <td style="color: var(--text-muted);">${bot.last_activity}</td>
                </tr>
            `).join('');
        }
    } catch (e) {
        console.error('Failed to refresh status:', e);
    }
}

let statusPollInterval = setInterval(refreshStatus, 5000);

document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        clearInterval(statusPollInterval);
    } else {
        refreshStatus();
        statusPollInterval = setInterval(refreshStatus, 5000);
    }
});

// Restart bot
async function restartBot() {
    const btn = document.getElementById('restart-btn');

    if (!confirm('Are you sure you want to restart the bot? This will briefly disconnect all bots.')) {
        return;
    }

    btn.disabled = true;
    btn.querySelector('.toggle-status').textContent = 'Restarting...';

    try {
        const response = await fetch('/api/restart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();

        if (data.status === 'ok') {
            showToast('Restart initiated. Page will reload in 5 seconds...', 'warning');
            setTimeout(() => { location.reload(); }, 5000);
        } else {
            showToast('Restart failed: ' + (data.message || 'Unknown error'), 'error');
            btn.disabled = false;
            btn.querySelector('.toggle-status').textContent = 'Restart';
        }
    } catch (e) {
        showToast('Failed to restart - check connection', 'error');
        btn.disabled = false;
        btn.querySelector('.toggle-status').textContent = 'Restart';
    }
}
</script>
{% endblock %}
