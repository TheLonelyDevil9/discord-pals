{% extends "base.html" %}

{% block title %}Configuration - Discord Pals{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Configuration</h1>
    <p class="page-subtitle">Runtime settings and bot configuration</p>
</div>

<!-- Core Settings -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Core Settings</span>
    </div>
    <div class="card-body">
        <form id="config-form">
            <div class="settings-grid">
                <div class="form-group">
                    <label for="history_limit">History Limit</label>
                    <div class="slider-row">
                        <input type="range" id="history_limit" name="history_limit" min="10" max="200" step="10"
                            value="{{ config.history_limit }}"
                            oninput="document.getElementById('history_val').textContent = this.value"
                            title="Total history limit">
                        <span class="slider-val" id="history_val">{{ config.history_limit }}</span>
                    </div>
                    <p class="form-hint">Total messages sent to LLM (includes history + immediate)</p>
                </div>

                <div class="form-group">
                    <label for="immediate_message_count">Immediate Messages</label>
                    <div class="slider-row">
                        <input type="range" id="immediate_message_count" name="immediate_message_count" min="1" max="20"
                            step="1" value="{{ config.immediate_message_count or 5 }}"
                            oninput="document.getElementById('immediate_val').textContent = this.value"
                            title="Immediate message count">
                        <span class="slider-val" id="immediate_val">{{ config.immediate_message_count or 5 }}</span>
                    </div>
                    <p class="form-hint">Priority messages placed after chatroom context</p>
                </div>

                {% if providers %}
                <div class="form-group">
                    <label for="active_provider">Active Provider</label>
                    <select id="active_provider" name="active_provider" title="Select AI provider">
                        <option value="">Auto (first available)</option>
                        {% for provider in providers %}
                        <option value="{{ provider }}" {% if config.active_provider==provider %}selected{% endif %}>{{ provider }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
            </div>

            <button type="submit" class="btn btn-primary">Save Settings</button>
        </form>
    </div>
</div>

{% if bots %}
<!-- Character Switcher -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Character Switcher</span>
    </div>
    <div class="card-body">
        {% for bot in bots %}
        <div class="bot-row">
            <span class="status-dot {% if bot.online %}online{% else %}offline{% endif %}"></span>
            <div class="bot-info">
                <span class="bot-name">{{ bot.name }}</span>
                <span class="bot-character">{{ bot.character }}</span>
            </div>
            <div class="bot-actions">
                <select id="char-{{ bot.name }}" title="Select character for {{ bot.name }}">
                    {% for char in characters %}
                    <option value="{{ char }}" {% if bot.character==char %}selected{% endif %}>{{ char }}</option>
                    {% endfor %}
                </select>
                <button type="button" class="btn btn-ghost btn-sm"
                    onclick="switchCharacter('{{ bot.name }}', document.getElementById('char-{{ bot.name }}').value)">Switch</button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Character Provider Preferences -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Character Provider Preferences</span>
    </div>
    <div class="card-body">
        <p class="form-hint" style="margin-bottom: 20px;">
            Assign preferred provider tiers to characters. Leave as "Default" to use the standard fallback order.
        </p>
        {% for char in characters %}
        <div class="bot-row compact">
            <span class="bot-name" style="min-width: 120px;">{{ char }}</span>
            <select id="char-provider-{{ char }}" title="Provider tier for {{ char }}">
                <option value="">Default (fallback order)</option>
                {% for tier in provider_tiers %}
                <option value="{{ tier }}" {% if character_providers.get(char) == tier %}selected{% endif %}>
                    {{ tier|capitalize }} ({{ providers_dict.get(tier, {}).get('name', tier) }})
                </option>
                {% endfor %}
            </select>
            <button type="button" class="btn btn-ghost btn-sm" onclick="saveCharacterProvider('{{ char }}')">Save</button>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Autonomous Channels -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Autonomous Channels</span>
    </div>
    <div class="card-body">
        {% for bot in bots %}
        <div class="auto-section">
            <div class="auto-section-header">{{ bot.name }}</div>
            {% if bot.auto_channels %}
            <ul class="channel-list">
                {% for ch in bot.auto_channels %}
                <li><span class="channel-tag">#{{ ch.name }}</span> <span class="text-muted">in {{ ch.guild }}</span></li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-muted">No autonomous channels enabled</p>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<!-- Name Trigger Settings -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Name Triggers</span>
    </div>
    <div class="card-body">
        <p class="form-hint" style="margin-bottom: 20px;">Bot responds when its name/nickname is mentioned (without @mention)</p>

        <div class="form-group">
            <label for="name_trigger_chance">Response Chance</label>
            <div class="slider-row">
                <input type="range" id="name_trigger_chance" name="name_trigger_chance" min="0" max="100" step="5"
                    value="{{ (config.name_trigger_chance or 1.0) * 100 | int }}"
                    oninput="document.getElementById('name_chance_val').textContent = this.value + '%'"
                    title="Name trigger response chance">
                <span class="slider-val" id="name_chance_val">{{ ((config.name_trigger_chance or 1.0) * 100) | int }}%</span>
            </div>
            <p class="form-hint">Chance to respond when bot name is mentioned</p>
        </div>

        <button type="button" class="btn btn-primary" onclick="saveNameTriggerSettings()">Save Chance</button>

        <div class="section-divider"></div>

        <h4 class="subsection-title">Per-Bot Nicknames</h4>
        <p class="form-hint" style="margin-bottom: 16px;">Comma-separated list of additional names each bot responds to</p>

        {% for bot in bots %}
        <div class="bot-row compact">
            <span class="status-dot {% if bot.online %}online{% else %}offline{% endif %}"></span>
            <span class="bot-name">{{ bot.name }}</span>
            <input type="text" id="nicknames-{{ bot.name }}" value="{{ bot.nicknames or '' }}"
                placeholder="e.g., bestie, buddy" title="Nicknames for {{ bot.name }}">
            <button type="button" class="btn btn-ghost btn-sm" onclick="saveNicknames('{{ bot.name }}')">Save</button>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Bot-on-Bot Fall-off -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Bot-on-Bot Fall-off</span>
    </div>
    <div class="card-body">
        <p class="form-hint" style="margin-bottom: 20px;">Gradually reduce response probability in bot-to-bot conversations</p>

        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="bot_falloff_enabled" {% if config.bot_falloff_enabled is not defined or config.bot_falloff_enabled %}checked{% endif %}
                    onchange="saveFalloffSettings()">
                <span>Enable Bot Fall-off</span>
            </label>
            <p class="form-hint">Bots gradually stop responding to each other after consecutive exchanges</p>
        </div>

        <div class="settings-grid">
            <div class="form-group">
                <label for="bot_falloff_base_chance">Base Chance</label>
                <div class="slider-row">
                    <input type="range" id="bot_falloff_base_chance" min="0" max="100" step="5"
                        value="{{ ((config.bot_falloff_base_chance or 0.8) * 100) | int }}"
                        oninput="document.getElementById('base_chance_val').textContent = this.value + '%'"
                        title="Base response chance">
                    <span class="slider-val" id="base_chance_val">{{ ((config.bot_falloff_base_chance or 0.8) * 100) | int }}%</span>
                </div>
                <p class="form-hint">Initial probability for first message</p>
            </div>

            <div class="form-group">
                <label for="bot_falloff_decay_rate">Decay Rate</label>
                <div class="slider-row">
                    <input type="range" id="bot_falloff_decay_rate" min="0" max="50" step="5"
                        value="{{ ((config.bot_falloff_decay_rate or 0.15) * 100) | int }}"
                        oninput="document.getElementById('decay_rate_val').textContent = this.value + '%'"
                        title="Decay rate per message">
                    <span class="slider-val" id="decay_rate_val">{{ ((config.bot_falloff_decay_rate or 0.15) * 100) | int }}%</span>
                </div>
                <p class="form-hint">Drop per consecutive bot message</p>
            </div>

            <div class="form-group">
                <label for="bot_falloff_min_chance">Minimum Chance</label>
                <div class="slider-row">
                    <input type="range" id="bot_falloff_min_chance" min="0" max="20" step="1"
                        value="{{ ((config.bot_falloff_min_chance or 0.05) * 100) | int }}"
                        oninput="document.getElementById('min_chance_val').textContent = this.value + '%'"
                        title="Minimum response chance">
                    <span class="slider-val" id="min_chance_val">{{ ((config.bot_falloff_min_chance or 0.05) * 100) | int }}%</span>
                </div>
                <p class="form-hint">Floor probability</p>
            </div>

            <div class="form-group">
                <label for="bot_falloff_hard_limit">Hard Limit</label>
                <div class="slider-row">
                    <input type="range" id="bot_falloff_hard_limit" min="3" max="25" step="1"
                        value="{{ config.bot_falloff_hard_limit or 10 }}"
                        oninput="document.getElementById('hard_limit_val').textContent = this.value"
                        title="Hard message limit">
                    <span class="slider-val" id="hard_limit_val">{{ config.bot_falloff_hard_limit or 10 }}</span>
                </div>
                <p class="form-hint">Stop responding after this many bot messages</p>
            </div>
        </div>

        <button type="button" class="btn btn-primary" onclick="saveFalloffSettings()">Save Fall-off Settings</button>
    </div>
</div>

<!-- Mention Settings -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Mention Settings</span>
    </div>
    <div class="card-body">
        <p class="form-hint" style="margin-bottom: 20px;">Control how bots use @mentions in their messages</p>

        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="allow_bot_mentions" {% if config.allow_bot_mentions is not defined or config.allow_bot_mentions %}checked{% endif %}
                    onchange="saveMentionSettings()">
                <span>Allow Bot @Mentions</span>
            </label>
            <p class="form-hint">Allow bots to generate @mentions for users in their messages</p>
        </div>

        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="allow_bot_to_bot_mentions" {% if config.allow_bot_to_bot_mentions %}checked{% endif %}
                    onchange="saveMentionSettings()">
                <span>Allow Bot-to-Bot @Mentions</span>
            </label>
            <p class="form-hint" style="color: var(--warning, #f59e0b);">Warning: Can cause conversation loops between bots!</p>
        </div>

        <div class="form-group">
            <label for="mention_context_limit">Mention Context Limit</label>
            <div class="slider-row">
                <input type="range" id="mention_context_limit" min="1" max="50" step="1"
                    value="{{ config.mention_context_limit or 10 }}"
                    oninput="document.getElementById('mention_context_val').textContent = this.value"
                    title="Max users in mention context">
                <span class="slider-val" id="mention_context_val">{{ config.mention_context_limit or 10 }}</span>
            </div>
            <p class="form-hint">Maximum users to include in mention context for AI</p>
        </div>

        <button type="button" class="btn btn-primary" onclick="saveMentionSettings()">Save Mention Settings</button>
    </div>
</div>

<!-- Split Replies -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Split Replies</span>
    </div>
    <div class="card-body">
        <p class="form-hint" style="margin-bottom: 20px;">Send separate replies to multiple mentioned users</p>

        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="split_replies_enabled" {% if config.split_replies_enabled %}checked{% endif %}
                    onchange="saveSplitReplySettings()">
                <span>Enable Split Replies</span>
            </label>
            <p class="form-hint">When multiple users are mentioned, send individual replies to each</p>
        </div>

        <div class="form-group">
            <label for="split_replies_max_targets">Max Split Targets</label>
            <div class="slider-row">
                <input type="range" id="split_replies_max_targets" min="1" max="10" step="1"
                    value="{{ config.split_replies_max_targets or 5 }}"
                    oninput="document.getElementById('split_targets_val').textContent = this.value"
                    title="Max users to split replies for">
                <span class="slider-val" id="split_targets_val">{{ config.split_replies_max_targets or 5 }}</span>
            </div>
            <p class="form-hint">Maximum users to split replies for (prevents spam)</p>
        </div>

        <button type="button" class="btn btn-primary" onclick="saveSplitReplySettings()">Save Split Reply Settings</button>
    </div>
</div>

<!-- Performance Settings -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Performance</span>
    </div>
    <div class="card-body">
        <p class="form-hint" style="margin-bottom: 20px;">Global performance and rate limiting settings</p>

        <div class="form-group">
            <label for="concurrency_limit">Concurrency Limit</label>
            <div class="slider-row">
                <input type="range" id="concurrency_limit" min="1" max="10" step="1"
                    value="{{ config.concurrency_limit or 4 }}"
                    oninput="document.getElementById('concurrency_val').textContent = this.value"
                    title="Max concurrent AI requests">
                <span class="slider-val" id="concurrency_val">{{ config.concurrency_limit or 4 }}</span>
            </div>
            <p class="form-hint">Maximum concurrent AI requests across all bots</p>
        </div>

        <button type="button" class="btn btn-primary" onclick="saveConcurrencySettings()">Save Performance Settings</button>
    </div>
</div>

<!-- Debug Settings -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Debug Settings</span>
    </div>
    <div class="card-body">
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="raw_generation_logging" {% if config.raw_generation_logging %}checked{% endif %}
                    onchange="toggleRawLogging(this.checked)">
                <span>Enable Raw Generation Logging</span>
            </label>
            <p class="form-hint">Log raw LLM output to live logs page (shows as [RAW-GEN] entries)</p>
        </div>
    </div>
</div>
{% endif %}

<!-- Export/Import -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Export / Import</span>
    </div>
    <div class="card-body">
        <div class="export-import-row">
            <a href="/settings/export" class="btn btn-primary">Export Config</a>
            <form action="/settings/import" method="post" enctype="multipart/form-data" class="import-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="file" name="config_zip" accept=".zip" title="Select config ZIP file">
                <button type="submit" class="btn btn-ghost">Import</button>
            </form>
        </div>
        <p class="form-hint">Export/import providers.json, bots.json, autonomous.json</p>
    </div>
</div>

<!-- Provider Management -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Provider Management</span>
    </div>
    <div class="card-body">
        <p class="form-hint" style="margin-bottom: 20px;">Drag to reorder providers. First available provider is used as fallback.</p>

        <div id="provider-list" class="provider-list">
            <!-- Populated by JavaScript -->
        </div>

        <div class="section-divider"></div>

        <h4 class="subsection-title">Add New Provider</h4>
        <form id="add-provider-form" class="provider-form">
            <div class="settings-grid">
                <div class="form-group">
                    <label for="new-provider-type">Provider Type</label>
                    <select id="new-provider-type" reqd onchange="updateProviderDefaults()">
                        <option value="">Select type...</option>
                        <option value="openai">OpenAI</option>
                        <option value="anthropic">Anthropic</option>
                        <option value="google">Google (Gemini)</option>
                        <option value="openrouter">OpenRouter</option>
                        <option value="local">Local / Custom</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-provider-name">Display Name</label>
                    <input type="text" id="new-provider-name" placeholder="e.g., GPT-4o" required>
                </div>
                <div class="form-group">
                    <label for="new-provider-endpoint">API Endpoint</label>
                    <input type="text" id="new-provider-endpoint" placeholder="https://api.openai.com/v1">
                </div>
                <div class="form-group">
                    <label for="new-provider-key">API Key</label>
                    <input type="password" id="new-provider-key" placeholder="sk-...">
                </div>
                <div class="form-group">
                    <label for="new-provider-model">Model</label>
                    <input type="text" id="new-provider-model" placeholder="gpt-4o">
                </div>
                <div class="form-group">
                    <label for="new-provider-temp">Temperature</label>
                    <input type="number" id="new-provider-temp" min="0" max="2" step="0.1" value="0.7">
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Add Provider</button>
        </form>

        <div class="section-divider"></div>

        <details class="config-editor">
            <summary>Advanced: Edit JSON directly</summary>
            <form action="/settings/providers/save" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <textarea name="content" id="providers-json-editor" class="json-editor" spellcheck="false" title="Providers JSON configuration">{{ providers_raw }}</textarea>
                <div class="editor-actions">
                    <button type="submit" class="btn btn-primary">Save JSON</button>
                    <button type="button" class="btn btn-ghost" onclick="formatJSON(this.form.content)">Format</button>
                </div>
            </form>
        </details>
    </div>
</div>

<!-- Edit Provider Modal -->
<div id="edit-provider-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Provider</h3>
            <button type="button" class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <form id="edit-provider-form" class="provider-form">
            <input type="hidden" id="edit-provider-index">
            <div class="settings-grid">
                <div class="form-group">
                    <label for="edit-provider-name">Display Name</label>
                    <input type="text" id="edit-provider-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-provider-endpoint">API Endpoint</label>
                    <input type="text" id="edit-provider-endpoint" placeholder="https://api.openai.com/v1">
                </div>
                <div class="form-group">
                    <label for="edit-provider-key">API Key</label>
                    <input type="password" id="edit-provider-key" placeholder="Leave blank to keep current">
                </div>
                <div class="form-group">
                    <label for="edit-provider-model">Model</label>
                    <input type="text" id="edit-provider-model">
                </div>
                <div class="form-group">
                    <label for="edit-provider-temp">Temperature</label>
                    <input type="number" id="edit-provider-temp" min="0" max="2" step="0.1">
                </div>
                <div class="form-group">
                    <label for="edit-provider-max-tokens">Max Tokens (optional)</label>
                    <input type="number" id="edit-provider-max-tokens" min="1" placeholder="Leave blank for default">
                </div>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <button type="button" class="btn btn-ghost" onclick="closeEditModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- JSON Configuration Editors -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Configuration Files</span>
    </div>
    <div class="card-body">
        <p class="form-hint" style="margin-bottom: 20px;">Edit JSON configuration files directly. Changes require a restart.</p>

        <details class="config-editor">
            <summary>bots.json</summary>
            <form action="/settings/bots/save" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <textarea name="content" class="json-editor" spellcheck="false" title="Bots JSON configuration">{{ bots_raw }}</textarea>
                <div class="editor-actions">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-ghost" onclick="formatJSON(this.form.content)">Format</button>
                </div>
            </form>
        </details>

        <details class="config-editor">
            <summary>autonomous.json</summary>
            <form action="/settings/autonomous/save" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <textarea name="content" class="json-editor" spellcheck="false" title="Autonomous JSON configuration">{{ autonomous_raw }}</textarea>
                <div class="editor-actions">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-ghost" onclick="formatJSON(this.form.content)">Format</button>
                </div>
            </form>
        </details>
    </div>
</div>

{% if message %}
<div class="toast success" style="position: static; margin-bottom: 20px;">{{ message }}</div>
{% endif %}
{% if error %}
<div class="toast error" style="position: static; margin-bottom: 20px;">{{ error }}</div>
{% endif %}

<style>
/* Page Header */
.page-header {
    margin-bottom: 32px;
}

.page-title {
    font-size: 1.875rem;
    font-weight: 600;
    letter-spacing: -0.025em;
    margin-bottom: 4px;
}

.page-subtitle {
    color: var(--text-muted);
    font-size: 0.875rem;
}

/* Settings Grid */
.settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
}

/* Form Elements */
.form-group {
    margin-bottom: 20px;
}

.form-group:last-child {
    margin-bottom: 0;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.form-hint {
    color: var(--text-muted);
    font-size: 0.75rem;
    margin-top: 6px;
}

.slider-row {
    display: flex;
    align-items: center;
    gap: 12px;
}

.slider-val {
    min-width: 48px;
    text-align: right;
    font-weight: 500;
    font-size: 0.875rem;
    color: var(--text-primary);
}

input[type="range"] {
    flex: 1;
    height: 6px;
    background: var(--bg-tertiary);
    border-radius: 3px;
    outline: none;
    -webkit-appearance: none;
}

input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    background: var(--accent);
    border-radius: 50%;
    cursor: pointer;
}

input[type="range"]::-moz-range-thumb {
    width: 16px;
    height: 16px;
    background: var(--accent);
    border-radius: 50%;
    cursor: pointer;
    border: none;
}

select {
    padding: 8px 12px;
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-primary);
    font-family: inherit;
    font-size: 0.875rem;
}

select:focus {
    outline: none;
    border-color: var(--accent);
}

/* Checkbox */
.checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
}

.checkbox-label input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: var(--accent);
}

.checkbox-label span {
    font-weight: 500;
    color: var(--text-primary);
}

/* Bot Row */
.bot-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--bg-primary);
    border-radius: 8px;
    margin-bottom: 12px;
}

.bot-row:last-child {
    margin-bottom: 0;
}

.bot-row.compact {
    padding: 10px 12px;
}

.bot-row.compact input[type="text"] {
    flex: 1;
    padding: 8px 12px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-primary);
    font-family: inherit;
    font-size: 0.875rem;
}

.bot-row.compact input[type="text"]:focus {
    outline: none;
    border-color: var(--accent);
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}

.status-dot.online {
    background: var(--success);
}

.status-dot.offline {
    background: var(--text-muted);
}

.bot-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.bot-name {
    font-weight: 500;
    color: var(--text-primary);
}

.bot-character {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.bot-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Auto Section */
.auto-section {
    padding: 16px;
    background: var(--bg-primary);
    border-radius: 8px;
    margin-bottom: 12px;
}

.auto-section:last-child {
    margin-bottom: 0;
}

.auto-section-header {
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 12px;
    font-size: 0.875rem;
}

.channel-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.channel-list li {
    padding: 6px 0;
    font-size: 0.875rem;
}

.channel-tag {
    color: var(--accent);
    font-weight: 500;
}

.text-muted {
    color: var(--text-muted);
}

/* Section Divider */
.section-divider {
    height: 1px;
    background: var(--border-subtle);
    margin: 24px 0;
}

.subsection-title {
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-primary);
}

/* Export/Import */
.export-import-row {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
    margin-bottom: 12px;
}

.import-form {
    display: flex;
    align-items: center;
    gap: 8px;
}

.import-form input[type="file"] {
    padding: 8px;
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-primary);
    font-size: 0.875rem;
}

/* JSON Editor */
.config-editor {
    margin-bottom: 12px;
    border: 1px solid var(--border-subtle);
    border-radius: 8px;
    overflow: hidden;
}

.config-editor:last-child {
    margin-bottom: 0;
}

.config-editor summary {
    cursor: pointer;
    padding: 12px 16px;
    background: var(--bg-primary);
    font-weight: 500;
    font-size: 0.875rem;
    user-select: none;
    transition: background 0.15s ease;
}

.config-editor summary:hover {
    background: var(--bg-tertiary);
}

.config-editor[open] summary {
    border-bottom: 1px solid var(--border-subtle);
}

.config-editor form {
    padding: 16px;
}

.json-editor {
    width: 100%;
    min-height: 250px;
    max-height: 400px;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
    font-size: 0.8125rem;
    line-height: 1.5;
    background: var(--bg-primary);
    color: var(--text-primary);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 12px;
    resize: vertical;
    tab-size: 2;
    white-space: pre;
    overflow-x: auto;
}

.json-editor:focus {
    outline: none;
    border-color: var(--accent);
}

.editor-actions {
    margin-top: 12px;
    display: flex;
    gap: 8px;
}

/* Button sizes */
.btn-sm {
    padding: 6px 12px;
    font-size: 0.8125rem;
}

/* Provider List */
.provider-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.provider-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: 8px;
    cursor: grab;
    transition: all 0.15s ease;
}

.provider-item:hover {
    border-color: var(--accent);
}

.provider-item.dragging {
    opacity: 0.5;
    cursor: grabbing;
}

.provider-item .drag-handle {
    color: var(--text-muted);
    cursor: grab;
}

.provider-item .provider-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.provider-item .provider-name {
    font-weight: 500;
    color: var(--text-primary);
}

.provider-item .provider-tier {
    font-weight: normal;
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-left: 4px;
}

.provider-item .provider-model {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.provider-item .provider-actions {
    display: flex;
    gap: 8px;
}

.provider-item .btn-icon {
    padding: 6px;
    background: transparent;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    border-radius: 4px;
}

.provider-item .btn-icon:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

.provider-item .btn-icon.delete:hover {
    color: var(--error, #ef4444);
}

.provider-item .btn-icon.edit:hover {
    color: var(--accent);
}

/* Edit Provider Modal */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal-overlay.active {
    display: flex;
}

.modal-content {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 24px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.modal-header h3 {
    margin: 0;
    color: var(--text-primary);
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--text-muted);
    cursor: pointer;
}

.modal-close:hover {
    color: var(--text-primary);
}

.provider-form input[type="text"],
.provider-form input[type="password"],
.provider-form input[type="number"] {
    width: 100%;
    padding: 8px 12px;
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-primary);
    font-family: inherit;
    font-size: 0.875rem;
}

.provider-form input:focus {
    outline: none;
    border-color: var(--accent);
}

/* Responsive */
@media (max-width: 768px) {
    .settings-grid {
        grid-template-columns: 1fr;
    }

    .bot-row {
        flex-wrap: wrap;
    }

    .bot-actions {
        width: 100%;
        margin-top: 8px;
    }

    .export-import-row {
        flex-direction: column;
        align-items: stretch;
    }

    .import-form {
        flex-direction: column;
        align-items: stretch;
    }
}
</style>

<script>
// Format JSON in textarea
function formatJSON(textarea) {
    try {
        const obj = JSON.parse(textarea.value);
        textarea.value = JSON.stringify(obj, null, 2);
        showToast('JSON formatted', 'success');
    } catch (e) {
        showToast('Invalid JSON: ' + e.message, 'error');
    }
}

// Tab key in JSON editors
document.querySelectorAll('.json-editor').forEach(textarea => {
    textarea.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
            e.preventDefault();
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            textarea.value = textarea.value.substring(0, start) + '  ' + textarea.value.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + 2;
        }
    });
});

// Save core settings
document.getElementById('config-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = {
        history_limit: parseInt(document.getElementById('history_limit').value),
        immediate_message_count: parseInt(document.getElementById('immediate_message_count').value),
        active_provider: document.getElementById('active_provider')?.value || null
    };

    const response = await fetch('/api/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': '{{ csrf_token() }}'
        },
        body: JSON.stringify(data)
    });

    if (response.ok) {
        showToast('Settings saved', 'success');
    } else {
        showToast('Failed to save settings', 'error');
    }
});

// Switch character
async function switchCharacter(botName, character, btn) {
    if (btn) {
        btn.disabled = true;
        btn.textContent = 'Switching...';
    }
    try {
        const response = await fetch('/api/switch_character', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ bot_name: botName, character: character })
        });

        const result = await response.json();
        if (result.status === 'ok') {
            showToast(`Switched to ${result.character}`, 'success');
            location.reload();
        } else {
            showToast('Error: ' + (result.message || 'Unknown error'), 'error');
        }
    } catch (e) {
        showToast('Failed to switch character', 'error');
    } finally {
        if (btn) {
            btn.disabled = false;
            btn.textContent = 'Switch';
        }
    }
}

// Save character provider preference
async function saveCharacterProvider(charName) {
    const select = document.getElementById('char-provider-' + charName);
    const tier = select.value;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;

    const response = await fetch('/api/character-provider', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken
        },
        body: JSON.stringify({ character: charName, tier: tier })
    });

    const result = await response.json();
    if (result.status === 'ok') {
        showToast(`Provider preference saved for ${charName}`, 'success');
    } else {
        showToast('Error: ' + (result.message || 'Unknown error'), 'error');
    }
}

// Save name trigger settings
async function saveNameTriggerSettings() {
    const data = {
        name_trigger_chance: parseInt(document.getElementById('name_trigger_chance').value) / 100
    };

    const response = await fetch('/api/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': '{{ csrf_token() }}'
        },
        body: JSON.stringify(data)
    });

    if (response.ok) {
        showToast('Name trigger chance saved', 'success');
    } else {
        showToast('Failed to save settings', 'error');
    }
}

// Save fall-off settings
async function saveFalloffSettings() {
    const data = {
        bot_falloff_enabled: document.getElementById('bot_falloff_enabled').checked,
        bot_falloff_base_chance: parseInt(document.getElementById('bot_falloff_base_chance').value) / 100,
        bot_falloff_decay_rate: parseInt(document.getElementById('bot_falloff_decay_rate').value) / 100,
        bot_falloff_min_chance: parseInt(document.getElementById('bot_falloff_min_chance').value) / 100,
        bot_falloff_hard_limit: parseInt(document.getElementById('bot_falloff_hard_limit').value)
    };

    const response = await fetch('/api/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': '{{ csrf_token() }}'
        },
        body: JSON.stringify(data)
    });

    if (response.ok) {
        showToast('Fall-off settings saved', 'success');
    } else {
        showToast('Failed to save settings', 'error');
    }
}

// Save mention settings
async function saveMentionSettings() {
    const data = {
        allow_bot_mentions: document.getElementById('allow_bot_mentions').checked,
        allow_bot_to_bot_mentions: document.getElementById('allow_bot_to_bot_mentions').checked,
        mention_context_limit: parseInt(document.getElementById('mention_context_limit').value)
    };

    const response = await fetch('/api/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': '{{ csrf_token() }}'
        },
        body: JSON.stringify(data)
    });

    if (response.ok) {
        showToast('Mention settings saved', 'success');
    } else {
        showToast('Failed to save settings', 'error');
    }
}

// Save split reply settings
async function saveSplitReplySettings() {
    const data = {
        split_replies_enabled: document.getElementById('split_replies_enabled').checked,
        split_replies_max_targets: parseInt(document.getElementById('split_replies_max_targets').value)
    };

    const response = await fetch('/api/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': '{{ csrf_token() }}'
        },
        body: JSON.stringify(data)
    });

    if (response.ok) {
        showToast('Split reply settings saved', 'success');
    } else {
        showToast('Failed to save settings', 'error');
    }
}

// Save concurrency settings
async function saveConcurrencySettings() {
    const data = {
        concurrency_limit: parseInt(document.getElementById('concurrency_limit').value)
    };

    const response = await fetch('/api/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': '{{ csrf_token() }}'
        },
        body: JSON.stringify(data)
    });

    if (response.ok) {
        showToast('Performance settings saved', 'success');
    } else {
        showToast('Failed to save settings', 'error');
    }
}

// Toggle raw logging
async function toggleRawLogging(enabled) {
    const response = await fetch('/api/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ raw_generation_logging: enabled })
    });

    if (response.ok) {
        showToast(enabled ? 'Raw logging enabled' : 'Raw logging disabled', 'success');
    } else {
        showToast('Failed to toggle setting', 'error');
    }
}

// Save nicknames
async function saveNicknames(botName) {
    const nicknames = document.getElementById('nicknames-' + botName).value.trim();

    const response = await fetch('/api/nicknames', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ bot_name: botName, nicknames: nicknames })
    });

    if (response.ok) {
        showToast('Nicknames saved for ' + botName, 'success');
    } else {
        showToast('Failed to save nicknames', 'error');
    }
}

// ============ Provider Management ============

let providersData = [];

// Load providers on page load
document.addEventListener('DOMContentLoaded', () => {
    loadProviders();
});

function loadProviders() {
    try {
        const jsonEditor = document.getElementById('providers-json-editor');
        if (jsonEditor) {
            const data = JSON.parse(jsonEditor.value);
            providersData = data.providers || [];
            renderProviderList();
        }
    } catch (e) {
        console.error('Failed to parse providers:', e);
    }
}

function getTierName(index) {
    const names = ['primary', 'secondary', 'fallback'];
    return index < 3 ? names[index] : `tier_${index}`;
}

function renderProviderList() {
    const list = document.getElementById('provider-list');
    if (!list) return;

    if (providersData.length === 0) {
        list.innerHTML = '<p class="text-muted">No providers configured. Add one below or edit the JSON directly.</p>';
        return;
    }

    list.innerHTML = providersData.map((p, i) => `
        <div class="provider-item" draggable="true" data-index="${i}">
            <span class="drag-handle">&#9776;</span>
            <div class="provider-info">
                <span class="provider-name">${escapeHtml(p.name || 'Unnamed')} <span class="provider-tier">(${getTierName(i)})</span></span>
                <span class="provider-model">${escapeHtml(p.model || 'No model')} &bull; ${escapeHtml(p.url || 'Default endpoint')}</span>
            </div>
            <div class="provider-actions">
                <button type="button" class="btn-icon edit" onclick="editProvider(${i})" title="Edit">&#9998;</button>
                <button type="button" class="btn-icon" onclick="testProvider(${i})" title="Test connection">&#9889;</button>
                <button type="button" class="btn-icon delete" onclick="deleteProvider(${i})" title="Delete">&times;</button>
            </div>
        </div>
    `).join('');

    // Add drag-and-drop handlers
    setupDragAndDrop();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function setupDragAndDrop() {
    const list = document.getElementById('provider-list');
    if (!list) return;

    // Destroy existing instance if any
    if (list.sortableInstance) {
        list.sortableInstance.destroy();
    }

    // Use Sortable.js for cross-platform drag-and-drop (works on mobile)
    list.sortableInstance = new Sortable(list, {
        animation: 150,
        handle: '.drag-handle',
        ghostClass: 'dragging',
        forceFallback: true,
        touchStartThreshold: 5,
        delayOnTouchOnly: true,
        delay: 100,
        onEnd: function(evt) {
            if (evt.oldIndex !== evt.newIndex) {
                reorderProviders(evt.oldIndex, evt.newIndex);
            }
        }
    });
}

async function reorderProviders(fromIndex, toIndex) {
    // Reorder in local array
    const [moved] = providersData.splice(fromIndex, 1);
    providersData.splice(toIndex, 0, moved);

    // Save to server
    await saveProvidersToServer();
    renderProviderList();
}

async function deleteProvider(index) {
    if (!confirm('Delete this provider?')) return;

    providersData.splice(index, 1);
    await saveProvidersToServer();
    renderProviderList();
    showToast('Provider deleted', 'success');
}

async function testProvider(index) {
    showToast('Testing provider...', 'success');
    const response = await fetch(`/api/test-provider/${index}`, {
        headers: { 'X-CSRF-Token': '{{ csrf_token() }}' }
    });
    const result = await response.json();
    if (result.success) {
        showToast('Provider is working!', 'success');
    } else {
        showToast('Provider test failed: ' + (result.error || 'Unknown error'), 'error');
    }
}

function editProvider(index) {
    const provider = providersData[index];
    if (!provider) return;

    document.getElementById('edit-provider-index').value = index;
    document.getElementById('edit-provider-name').value = provider.name || '';
    document.getElementById('edit-provider-endpoint').value = provider.url || '';  // Use 'url' not 'base_url'
    document.getElementById('edit-provider-key').value = '';  // Don't show existing key
    document.getElementById('edit-provider-model').value = provider.model || '';
    document.getElementById('edit-provider-temp').value = provider.temperature ?? 0.7;
    document.getElementById('edit-provider-max-tokens').value = provider.max_tokens || '';

    document.getElementById('edit-provider-modal').classList.add('active');
}

function closeEditModal() {
    document.getElementById('edit-provider-modal').classList.remove('active');
}

document.getElementById('edit-provider-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const index = parseInt(document.getElementById('edit-provider-index').value);
    const provider = providersData[index];
    if (!provider) return;

    provider.name = document.getElementById('edit-provider-name').value.trim();
    provider.url = document.getElementById('edit-provider-endpoint').value.trim() || undefined;  // Use 'url' not 'base_url'
    provider.model = document.getElementById('edit-provider-model').value.trim();
    provider.temperature = parseFloat(document.getElementById('edit-provider-temp').value) || 0.7;

    const newKey = document.getElementById('edit-provider-key').value.trim();
    if (newKey) {
        provider.api_key = newKey;
    }

    const maxTokens = document.getElementById('edit-provider-max-tokens').value.trim();
    if (maxTokens) {
        provider.max_tokens = parseInt(maxTokens);
    } else {
        delete provider.max_tokens;
    }

    // Clean up undefined values
    if (!provider.url) delete provider.url;

    await saveProvidersToServer();
    renderProviderList();
    closeEditModal();
    showToast('Provider updated', 'success');
});

// Close modal on outside click
document.getElementById('edit-provider-modal')?.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal-overlay')) {
        closeEditModal();
    }
});

async function saveProvidersToServer() {
    const data = { providers: providersData };
    const jsonStr = JSON.stringify(data, null, 2);

    // Update the JSON editor too
    const jsonEditor = document.getElementById('providers-json-editor');
    if (jsonEditor) {
        jsonEditor.value = jsonStr;
    }

    const response = await fetch('/api/providers/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ content: jsonStr })
    });

    if (!response.ok) {
        showToast('Failed to save providers', 'error');
    }
}

// Provider type defaults
const providerDefaults = {
    openai: { url: 'https://api.openai.com/v1', model: 'gpt-4o' },
    anthropic: { url: 'https://api.anthropic.com/v1', model: 'claude-sonnet-4-20250514' },
    google: { url: 'https://generativelanguage.googleapis.com/v1beta', model: 'gemini-1.5-pro' },
    openrouter: { url: 'https://openrouter.ai/api/v1', model: 'openai/gpt-4o' },
    local: { url: 'http://localhost:5000/v1', model: 'local-model' }
};

function updateProviderDefaults() {
    const type = document.getElementById('new-provider-type').value;
    if (type && providerDefaults[type]) {
        document.getElementById('new-provider-endpoint').value = providerDefaults[type].url;
        document.getElementById('new-provider-model').value = providerDefaults[type].model;
    }
}

// Add provider form
document.getElementById('add-provider-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = document.getElementById('new-provider-name').value.trim();
    const url = document.getElementById('new-provider-endpoint').value.trim();
    const api_key = document.getElementById('new-provider-key').value.trim();
    const model = document.getElementById('new-provider-model').value.trim();
    const temperature = parseFloat(document.getElementById('new-provider-temp').value) || 0.7;

    if (!name) {
        showToast('Provider name is required', 'error');
        return;
    }

    const newProvider = { name, model, temperature };
    if (url) newProvider.url = url;
    if (api_key) newProvider.api_key = api_key;

    providersData.push(newProvider);
    await saveProvidersToServer();
    renderProviderList();

    // Reset form
    e.target.reset();
    showToast('Provider added', 'success');
});
</script>
{% endblock %}
