{% extends "base.html" %}

{% block title %}Configuration - Discord Pals{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Configuration</h1>
    <p class="page-subtitle">Runtime settings and bot configuration</p>
</div>

<!-- Core Settings -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Core Settings</span>
    </div>
    <div class="card-body">
        <form id="config-form">
            <div class="settings-grid">
                <div class="form-group">
                    <label for="history_limit">History Limit</label>
                    <div class="slider-row">
                        <input type="range" id="history_limit" name="history_limit" min="10" max="200" step="10"
                            value="{{ config.history_limit }}"
                            oninput="document.getElementById('history_val').textContent = this.value"
                            title="Total history limit">
                        <span class="slider-val" id="history_val">{{ config.history_limit }}</span>
                    </div>
                    <p class="form-hint">Total messages sent to LLM (includes history + immediate)</p>
                </div>

                <div class="form-group">
                    <label for="immediate_message_count">Immediate Messages</label>
                    <div class="slider-row">
                        <input type="range" id="immediate_message_count" name="immediate_message_count" min="1" max="20"
                            step="1" value="{{ config.immediate_message_count or 5 }}"
                            oninput="document.getElementById('immediate_val').textContent = this.value"
                            title="Immediate message count">
                        <span class="slider-val" id="immediate_val">{{ config.immediate_message_count or 5 }}</span>
                    </div>
                    <p class="form-hint">Priority messages placed after chatroom context</p>
                </div>

                <div class="form-group">
                    <label for="batch_timeout">Batch Timeout</label>
                    <div class="slider-row">
                        <input type="range" id="batch_timeout" name="batch_timeout" min="5" max="30" step="1"
                      value="{{ config.batch_timeout }}"
                            oninput="document.getElementById('batch_val').textContent = this.value + 's'"
                            title="Batch collection time">
                        <span class="slider-val" id="batch_val">{{ config.batch_timeout }}s</span>
                    </div>
                    <p class="form-hint">Time to wait for follow-up messages before responding</p>
                </div>

                {% if providers %}
                <div class="form-group">
                    <label for="active_provider">Active Provider</label>
                    <select id="active_provider" name="active_provider" title="Select AI provider">
                        <option value="">Auto (first available)</option>
                        {% for provider in providers %}
                        <option value="{{ provider }}" {% if config.active_provider==provider %}selected{% endif %}>{{ provider }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
            </div>

            <button type="submit" class="btn btn-primary">Save Settings</button>
        </form>
    </div>
</div>

{% if bots %}
<!-- Character Switcher -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Character Switcher</span>
    </div>
    <div class="card-body">
        {% for bot in bots %}
        <div class="bot-row">
            <span class="status-dot {% if bot.online %}online{% else %}offline{% endif %}"></span>
            <div class="bot-info">
                <span class="bot-name">{{ bot.name }}</span>
                <span class="bot-character">{{ bot.character }}</span>
            </div>
            <div class="bot-actions">
                <select id="char-{{ bot.name }}" title="Select character for {{ bot.name }}">
                    {% for char in characters %}
                    <option value="{{ char }}" {% if bot.character==char %}selected{% endif %}>{{ char }}</option>
                    {% endfor %}
                </select>
                <button type="button" class="btn btn-ghost btn-sm"
                    onclick="switchCharacter('{{ bot.name }}', document.getElementById('char-{{ bot.name }}').value)">Switch</button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Character Provider Preferences -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Character Provider Preferences</span>
    </div>
    <div class="card-body">
        <p class="form-hint" style="margin-bottom: 20px;">
            Assign preferred provider tiers to characters. Leave as "Default" to use the standard fallback order.
        </p>
        {% for char in characters %}
        <div class="bot-row compact">
            <span class="bot-name" style="min-width: 120px;">{{ char }}</span>
            <select id="char-provider-{{ char }}" title="Provider tier for {{ char }}">
                <option value="">Default (fallback order)</option>
                {% for tier in provider_tiers %}
                <option value="{{ tier }}" {% if character_providers.get(char) == tier %}selected{% endif %}>
                    {{ tier|capitalize }} ({{ providers_dict.get(tier, {}).get('name', tier) }})
                </option>
                {% endfor %}
            </select>
            <button type="button" class="btn btn-ghost btn-sm" onclick="saveCharacterProvider('{{ char }}')">Save</button>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Autonomous Channels -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Autonomous Channels</span>
    </div>
    <div class="card-body">
        {% for bot in bots %}
        <div class="auto-section">
            <div class="auto-section-header">{{ bot.name }}</div>
            {% if bot.auto_channels %}
            <ul class="channel-list">
                {% for ch in bot.auto_channels %}
                <li><span class="channel-tag">#{{ ch.name }}</span> <span class="text-muted">in {{ ch.guild }}</span></li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-muted">No autonomous channels enabled</p>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<!-- Name Trigger Settings -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Name Triggers</span>
    </div>
    <div class="card-body">
        <p class="form-hint" style="margin-bottom: 20px;">Bot responds when its name/nickname is mentioned (without @mention)</p>

        <div class="form-group">
            <label for="name_trigger_chance">Response Chance</label>
            <div class="slider-row">
                <input type="range" id="name_trigger_chance" name="name_trigger_chance" min="0" max="100" step="5"
                    value="{{ (config.name_trigger_chance or 1.0) * 100 | int }}"
                    oninput="document.getElementById('name_chance_val').textContent = this.value + '%'"
                    title="Name trigger response chance">
                <span class="slider-val" id="name_chance_val">{{ ((config.name_trigger_chance or 1.0) * 100) | int }}%</span>
            </div>
            <p class="form-hint">Chance to respond when bot name is mentioned</p>
        </div>

        <button type="button" class="btn btn-primary" onclick="saveNameTriggerSettings()">Save Chance</button>

        <div class="section-divider"></div>

        <h4 class="subsection-title">Per-Bot Nicknames</h4>
        <p class="form-hint" style="margin-bottom: 16px;">Comma-separated list of additional names each bot responds to</p>

        {% for bot in bots %}
        <div class="bot-row compact">
            <span class="status-dot {% if bot.online %}online{% else %}offline{% endif %}"></span>
            <span class="bot-name">{{ bot.name }}</span>
            <input type="text" id="nicknames-{{ bot.name }}" value="{{ bot.nicknames or '' }}"
                placeholder="e.g., bestie, buddy" title="Nicknames for {{ bot.name }}">
            <button type="button" class="btn btn-ghost btn-sm" onclick="saveNicknames('{{ bot.name }}')">Save</button>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Bot-on-Bot Fall-off -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Bot-on-Bot Fall-off</span>
    </div>
    <div class="card-body">
        <p class="form-hint" style="margin-bottom: 20px;">Gradually reduce response probability in bot-to-bot conversations</p>

        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="bot_falloff_enabled" {% if config.bot_falloff_enabled is not defined or config.bot_falloff_enabled %}checked{% endif %}
                    onchange="saveFalloffSettings()">
                <span>Enable Bot Fall-off</span>
            </label>
            <p class="form-hint">Bots gradually stop responding to each other after consecutive exchanges</p>
        </div>

        <div class="settings-grid">
            <div class="form-group">
                <label for="bot_falloff_base_chance">Base Chance</label>
                <div class="slider-row">
                    <input type="range" id="bot_falloff_base_chance" min="0" max="100" step="5"
                        value="{{ ((config.bot_falloff_base_chance or 0.8) * 100) | int }}"
                        oninput="document.getElementById('base_chance_val').textContent = this.value + '%'"
                        title="Base response chance">
                    <span class="slider-val" id="base_chance_val">{{ ((config.bot_falloff_base_chance or 0.8) * 100) | int }}%</span>
                </div>
                <p class="form-hint">Initial probability for first message</p>
            </div>

            <div class="form-group">
                <label for="bot_falloff_decay_rate">Decay Rate</label>
                <div class="slider-row">
                    <input type="range" id="bot_falloff_decay_rate" min="0" max="50" step="5"
                        value="{{ ((config.bot_falloff_decay_rate or 0.15) * 100) | int }}"
                        oninput="document.getElementById('decay_rate_val').textContent = this.value + '%'"
                        title="Decay rate per message">
                    <span class="slider-val" id="decay_rate_val">{{ ((config.bot_falloff_decay_rate or 0.15) * 100) | int }}%</span>
                </div>
                <p class="form-hint">Drop per consecutive bot message</p>
            </div>

            <div class="form-group">
                <label for="bot_falloff_min_chance">Minimum Chance</label>
                <div class="slider-row">
                    <input type="range" id="bot_falloff_min_chance" min="0" max="20" step="1"
                        value="{{ ((config.bot_falloff_min_chance or 0.05) * 100) | int }}"
                        oninput="document.getElementById('min_chance_val').textContent = this.value + '%'"
                        title="Minimum response chance">
                    <span class="slider-val" id="min_chance_val">{{ ((config.bot_falloff_min_chance or 0.05) * 100) | int }}%</span>
                </div>
                <p class="form-hint">Floor probability</p>
            </div>

            <div class="form-group">
                <label for="bot_falloff_hard_limit">Hard Limit</label>
                <div class="slider-row">
                    <input type="range" id="bot_falloff_hard_limit" min="3" max="25" step="1"
                        value="{{ config.bot_falloff_hard_limit or 10 }}"
                        oninput="document.getElementById('hard_limit_val').textContent = this.value"
                        title="Hard message limit">
                    <span class="slider-val" id="hard_limit_val">{{ config.bot_falloff_hard_limit or 10 }}</span>
                </div>
                <p class="form-hint">Stop responding after this many bot messages</p>
            </div>
        </div>

        <button type="button" class="btn btn-primary" onclick="saveFalloffSettings()">Save Fall-off Settings</button>
    </div>
</div>

<!-- Debug Settings -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Debug Settings</span>
    </div>
    <div class="card-body">
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="raw_generation_logging" {% if config.raw_generation_logging %}checked{% endif %}
                    onchange="toggleRawLogging(this.checked)">
                <span>Enable Raw Generation Logging</span>
            </label>
            <p class="form-hint">Log raw LLM output to live logs page (shows as [RAW-GEN] entries)</p>
        </div>
    </div>
</div>
{% endif %}

<!-- Export/Import -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Export / Import</span>
    </div>
    <div class="card-body">
        <div class="export-import-row">
            <a href="/settings/export" class="btn btn-primary">Export Config</a>
            <form action="/settings/import" method="post" enctype="multipart/form-data" class="import-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="file" name="config_zip" accept=".zip" title="Select config ZIP file">
                <button type="submit" class="btn btn-ghost">Import</button>
            </form>
        </div>
        <p class="form-hint">Export/import providers.json, bots.json, autonomous.json</p>
    </div>
</div>

<!-- JSON Configuration Editors -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Configuration Files</span>
    </div>
    <div class="card-body">
        <p class="form-hint" style="margin-bottom: 20px;">Edit JSON configuration files directly. Changes require a restart.</p>

        <details class="config-editor">
            <summary>providers.json</summary>
            <form action="/settings/providers/save" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <textarea name="content" class="json-editor" spellcheck="false" title="Providers JSON configuration">{{ providers_raw }}</textarea>
                <div class="editor-actions">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-ghost" onclick="formatJSON(this.form.content)">Format</button>
                </div>
            </form>
        </details>

        <details class="config-editor">
            <summary>bots.json</summary>
            <form action="/settings/bots/save" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <textarea name="content" class="json-editor" spellcheck="false" title="Bots JSON configuration">{{ bots_raw }}</textarea>
                <div class="editor-actions">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-ghost" onclick="formatJSON(this.form.content)">Format</button>
                </div>
            </form>
        </details>

        <details class="config-editor">
            <summary>autonomous.json</summary>
            <form action="/settings/autonomous/save" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <textarea name="content" class="json-editor" spellcheck="false" title="Autonomous JSON configuration">{{ autonomous_raw }}</textarea>
                <div class="editor-actions">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-ghost" onclick="formatJSON(this.form.content)">Format</button>
                </div>
            </form>
        </details>
    </div>
</div>

{% if message %}
<div class="toast success" style="position: static; margin-bottom: 20px;">{{ message }}</div>
{% endif %}
{% if error %}
<div class="toast error" style="position: static; margin-bottom: 20px;">{{ error }}</div>
{% endif %}

<style>
/* Page Header */
.page-header {
    margin-bottom: 32px;
}

.page-title {
    font-size: 1.875rem;
    font-weight: 600;
    letter-spacing: -0.025em;
    margin-bottom: 4px;
}

.page-subtitle {
    color: var(--text-muted);
    font-size: 0.875rem;
}

/* Settings Grid */
.settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
}

/* Form Elements */
.form-group {
    margin-bottom: 20px;
}

.form-group:last-child {
    margin-bottom: 0;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.form-hint {
    color: var(--text-muted);
    font-size: 0.75rem;
    margin-top: 6px;
}

.slider-row {
    display: flex;
    align-items: center;
    gap: 12px;
}

.slider-val {
    min-width: 48px;
    text-align: right;
    font-weight: 500;
    font-size: 0.875rem;
    color: var(--text-primary);
}

input[type="range"] {
    flex: 1;
    height: 6px;
    background: var(--bg-tertiary);
    border-radius: 3px;
    outline: none;
    -webkit-appearance: none;
}

input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    background: var(--accent);
    border-radius: 50%;
    cursor: pointer;
}

input[type="range"]::-moz-range-thumb {
    width: 16px;
    height: 16px;
    background: var(--accent);
    border-radius: 50%;
    cursor: pointer;
    border: none;
}

select {
    padding: 8px 12px;
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-primary);
    font-family: inherit;
    font-size: 0.875rem;
}

select:focus {
    outline: none;
    border-color: var(--accent);
}

/* Checkbox */
.checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
}

.checkbox-label input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: var(--accent);
}

.checkbox-label span {
    font-weight: 500;
    color: var(--text-primary);
}

/* Bot Row */
.bot-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--bg-primary);
    border-radius: 8px;
    margin-bottom: 12px;
}

.bot-row:last-child {
    margin-bottom: 0;
}

.bot-row.compact {
    padding: 10px 12px;
}

.bot-row.compact input[type="text"] {
    flex: 1;
    padding: 8px 12px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-primary);
    font-family: inherit;
    font-size: 0.875rem;
}

.bot-row.compact input[type="text"]:focus {
    outline: none;
    border-color: var(--accent);
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}

.status-dot.online {
    background: var(--success);
}

.status-dot.offline {
    background: var(--text-muted);
}

.bot-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.bot-name {
    font-weight: 500;
    color: var(--text-primary);
}

.bot-character {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.bot-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Auto Section */
.auto-section {
    padding: 16px;
    background: var(--bg-primary);
    border-radius: 8px;
    margin-bottom: 12px;
}

.auto-section:last-child {
    margin-bottom: 0;
}

.auto-section-header {
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 12px;
    font-size: 0.875rem;
}

.channel-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.channel-list li {
    padding: 6px 0;
    font-size: 0.875rem;
}

.channel-tag {
    color: var(--accent);
    font-weight: 500;
}

.text-muted {
    color: var(--text-muted);
}

/* Section Divider */
.section-divider {
    height: 1px;
    background: var(--border-subtle);
    margin: 24px 0;
}

.subsection-title {
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-primary);
}

/* Export/Import */
.export-import-row {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
    margin-bottom: 12px;
}

.import-form {
    display: flex;
    align-items: center;
    gap: 8px;
}

.import-form input[type="file"] {
    padding: 8px;
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-primary);
    font-size: 0.875rem;
}

/* JSON Editor */
.config-editor {
    margin-bottom: 12px;
    border: 1px solid var(--border-subtle);
    border-radius: 8px;
    overflow: hidden;
}

.config-editor:last-child {
    margin-bottom: 0;
}

.config-editor summary {
    cursor: pointer;
    padding: 12px 16px;
    background: var(--bg-primary);
    font-weight: 500;
    font-size: 0.875rem;
    user-select: none;
    transition: background 0.15s ease;
}

.config-editor summary:hover {
    background: var(--bg-tertiary);
}

.config-editor[open] summary {
    border-bottom: 1px solid var(--border-subtle);
}

.config-editor form {
    padding: 16px;
}

.json-editor {
    width: 100%;
    min-height: 250px;
    max-height: 400px;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
    font-size: 0.8125rem;
    line-height: 1.5;
    background: var(--bg-primary);
    color: var(--text-primary);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 12px;
    resize: vertical;
    tab-size: 2;
    white-space: pre;
    overflow-x: auto;
}

.json-editor:focus {
    outline: none;
    border-color: var(--accent);
}

.editor-actions {
    margin-top: 12px;
    display: flex;
    gap: 8px;
}

/* Button sizes */
.btn-sm {
    padding: 6px 12px;
    font-size: 0.8125rem;
}

/* Responsive */
@media (max-width: 768px) {
    .settings-grid {
        grid-template-columns: 1fr;
    }

    .bot-row {
        flex-wrap: wrap;
    }

    .bot-actions {
        width: 100%;
        margin-top: 8px;
    }

    .export-import-row {
        flex-direction: column;
        align-items: stretch;
    }

    .import-form {
        flex-direction: column;
        align-items: stretch;
    }
}
</style>

<script>
// Format JSON in textarea
function formatJSON(textarea) {
    try {
        const obj = JSON.parse(textarea.value);
        textarea.value = JSON.stringify(obj, null, 2);
        showToast('JSON formatted', 'success');
    } catch (e) {
        showToast('Invalid JSON: ' + e.message, 'error');
    }
}

// Tab key in JSON editors
document.querySelectorAll('.json-editor').forEach(textarea => {
    textarea.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
            e.preventDefault();
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            textarea.value = textarea.value.substring(0, start) + '  ' + textarea.value.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + 2;
        }
    });
});

// Save core settings
document.getElementById('config-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = {
        history_limit: parseInt(document.getElementById('history_limit').value),
        immediate_message_count: parseInt(document.getElementById('immediate_message_count').value),
        batch_timeout: parseInt(document.getElementById('batch_timeout').value),
        active_provider: document.getElementById('active_provider')?.value || null
    };

    const response = await fetch('/api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });

    if (response.ok) {
        showToast('Settings saved', 'success');
    } else {
        showToast('Failed to save settings', 'error');
    }
});

// Switch character
async function switchCharacter(botName, character) {
    const response = await fetch('/api/switch_character', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bot_name: botName, character: character })
    });

    const result = await response.json();
    if (result.status === 'ok') {
        showToast(`Switched to ${result.character}`, 'success');
        location.reload();
    } else {
        showToast('Error: ' + (result.message || 'Unknown error'), 'error');
    }
}

// Save character provider preference
async function saveCharacterProvider(charName) {
    const select = document.getElementById('char-provider-' + charName);
    const tier = select.value;

    const response = await fetch('/api/character-provider', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ character: charName, tier: tier })
    });

    const result = await response.json();
    if (result.status === 'ok') {
        showToast(`Provider preference saved for ${charName}`, 'success');
    } else {
        showToast('Error: ' + (result.message || 'Unknown error'), 'error');
    }
}

// Save name trigger settings
async function saveNameTriggerSettings() {
    const data = {
        name_trigger_chance: parseInt(document.getElementById('name_trigger_chance').value) / 100
    };

    const response = await fetch('/api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });

    if (response.ok) {
        showToast('Name trigger chance saved', 'success');
    } else {
        showToast('Failed to save settings', 'error');
    }
}

// Save fall-off settings
async function saveFalloffSettings() {
    const data = {
        bot_falloff_enabled: document.getElementById('bot_falloff_enabled').checked,
        bot_falloff_base_chance: parseInt(document.getElementById('bot_falloff_base_chance').value) / 100,
        bot_falloff_decay_rate: parseInt(document.getElementById('bot_falloff_decay_rate').value) / 100,
        bot_falloff_min_chance: parseInt(document.getElementById('bot_falloff_min_chance').value) / 100,
        bot_falloff_hard_limit: parseInt(document.getElementById('bot_falloff_hard_limit').value)
    };

    const response = await fetch('/api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });

    if (response.ok) {
        showToast('Fall-off settings saved', 'success');
    } else {
        showToast('Failed to save settings', 'error');
    }
}

// Toggle raw logging
async function toggleRawLogging(enabled) {
    const response = await fetch('/api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ raw_generation_logging: enabled })
    });

    if (response.ok) {
        showToast(enabled ? 'Raw logging enabled' : 'Raw logging disabled', 'success');
    } else {
        showToast('Failed to toggle setting', 'error');
    }
}

// Save nicknames
async function saveNicknames(botName) {
    const nicknames = document.getElementById('nicknames-' + botName).value.trim();

    const response = await fetch('/api/nicknames', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bot_name: botName, nicknames: nicknames })
    });

    if (response.ok) {
        showToast('Nicknames saved for ' + botName, 'success');
    } else {
        showToast('Failed to save nicknames', 'error');
    }
}
</script>
{% endblock %}
