{% extends "base.html" %}

{% block title %}Context Viewer - Discord Pals{% endblock %}

{% block content %}
<h1>üîç Context Visualization</h1>

<p style="color: var(--text-muted); margin-bottom: 20px;">
    See exactly what was sent to the LLM on the last API call for each bot.
</p>

{% if contexts %}
{% for bot_name, ctx in contexts.items() %}
<div class="card">
    <h2>{{ bot_name }}</h2>
    <div style="display: flex; gap: 10px; margin-bottom: 15px; color: var(--text-muted);">
        <span>Messages: {{ ctx.message_count }}</span>
        <span>‚Ä¢</span>
        <span>Est. Tokens: ~{{ ctx.token_estimate }}</span>
    </div>

    <div class="context-section">
        <h3>System Prompt</h3>
        <pre class="context-box">{{ ctx.system_prompt }}</pre>
    </div>

    <div class="context-section">
        <h3>Messages ({{ ctx.messages|length }})</h3>
        <div class="messages-list">
            {% for msg in ctx.messages[-20:] %}
            <div class="message {% if msg.role == 'assistant' %}assistant{% else %}user{% endif %}">
                <strong>{{ msg.role }}:</strong>
                <span>{{ msg.content[:500] }}{% if msg.content|length > 500 %}...{% endif %}</span>
            </div>
            {% endfor %}
            {% if ctx.messages|length > 20 %}
            <div style="color: var(--text-muted); text-align: center; padding: 10px;">
                ... and {{ ctx.messages|length - 20 }} more messages
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endfor %}
{% else %}
<div class="card">
    <p style="color: var(--text-muted); text-align: center; padding: 40px;">
        No context stored yet. Make a request to any bot to see what's sent to the LLM.
    </p>
</div>
{% endif %}

<style>
    .context-section {
        margin-bottom: 20px;
    }

    .context-section h3 {
        margin-bottom: 10px;
        color: var(--accent);
    }

    .context-box {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 15px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 0.85em;
    }

    .messages-list {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 6px;
        max-height: 400px;
        overflow-y: auto;
    }

    .message {
        padding: 10px 15px;
        border-bottom: 1px solid var(--border);
    }

    .message:last-child {
        border-bottom: none;
    }

    .message.assistant {
        background: rgba(88, 166, 255, 0.1);
    }

    .message.user {
        background: transparent;
    }

    .message strong {
        color: var(--accent);
        margin-right: 8px;
    }
</style>
{% endblock %}