{% extends "base.html" %}
{% block title %}Edit {{ name }} - Discord Pals{% endblock %}

{% block content %}
<div class="page-header">
    <div class="breadcrumb">
        <a href="/characters" class="breadcrumb-link">Characters</a>
        <span class="breadcrumb-sep">/</span>
        <span class="breadcrumb-current">{{ name }}</span>
    </div>
    <h1 class="page-title">Edit Character</h1>
</div>

<div class="card">
    <div class="card-header">
        <span class="card-title">{{ name }}</span>
    </div>
    <div class="card-body">
        <div class="provider-select">
            <label for="provider-tier">Preferred Provider</label>
            <select id="provider-tier" onchange="updateProviderSection()" title="Select preferred provider tier">
                <option value="">Default (use fallback order)</option>
                <option value="primary">Primary</option>
                <option value="secondary">Secondary</option>
                <option value="fallback">Fallback</option>
            </select>
            <span class="provider-hint">This character will prefer the selected provider tier</span>
        </div>
        <form action="/characters/{{ name }}/save" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <textarea id="character-editor" name="content" class="editor-textarea" title="Character content">{{ content }}</textarea>
            <div class="editor-actions">
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <a href="/characters" class="btn btn-ghost">Cancel</a>
            </div>
        </form>
    </div>
</div>

<div class="card danger-zone">
    <div class="card-header">
        <span class="card-title danger-title">Danger Zone</span>
    </div>
    <div class="card-body">
        <p class="danger-desc">Once you delete a character, there is no going back. Please be certain.</p>
        <form action="/characters/{{ name }}/delete" method="post" style="display: inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete {{ name }}? This cannot be undone.')">
                Delete Character
            </button>
        </form>
    </div>
</div>

<style>
.page-header {
    margin-bottom: 32px;
}

.breadcrumb {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    font-size: 0.875rem;
}

.breadcrumb-link {
    color: var(--text-muted);
    text-decoration: none;
}

.breadcrumb-link:hover {
    color: var(--text-primary);
}

.breadcrumb-sep {
    color: var(--text-muted);
}

.breadcrumb-current {
    color: var(--text-secondary);
}

.page-title {
    font-size: 1.875rem;
    font-weight: 600;
    letter-spacing: -0.025em;
}

.editor-textarea {
    width: 100%;
    height: 500px;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
    font-size: 0.8125rem;
    resize: vertical;
}

.editor-actions {
    margin-top: 16px;
    display: flex;
    gap: 12px;
}

.danger-zone {
    border-color: var(--danger);
}

.danger-title {
    color: var(--danger);
}

.danger-desc {
    color: var(--text-muted);
    font-size: 0.875rem;
    margin-bottom: 16px;
}

/* Provider Select */
.provider-select {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-subtle);
}

.provider-select label {
    font-weight: 500;
    font-size: 0.875rem;
}

.provider-select select {
    padding: 6px 12px;
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-primary);
    font-family: inherit;
    font-size: 0.875rem;
}

.provider-hint {
    color: var(--text-muted);
    font-size: 0.75rem;
}
</style>

<script>
// Parse existing provider from content
function parseProvider(content) {
    const match = content.match(/##\s*Provider\s*\n(\w+)/i);
    return match ? match[1].toLowerCase() : '';
}

// Update provider section in markdown
function updateProviderSection() {
    const select = document.getElementById('provider-tier');
    const textarea = document.getElementById('character-editor');
    let content = textarea.value;
    const newProvider = select.value;

    // Remove existing Provider section
    content = content.replace(/\n*##\s*Provider\s*\n\w+\s*/gi, '');

    // Add new Provider section if selected
    if (newProvider) {
        // Add before Special Users section if it exists, otherwise at end
        const specialUsersMatch = content.match(/\n##\s*Special Users?/i);
        if (specialUsersMatch) {
            const insertPos = content.indexOf(specialUsersMatch[0]);
            content = content.slice(0, insertPos) + `\n\n## Provider\n${newProvider}` + content.slice(insertPos);
        } else {
            content = content.trimEnd() + `\n\n## Provider\n${newProvider}\n`;
        }
    }

    textarea.value = content;
}

// Initialize dropdown from content on page load
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.getElementById('character-editor');
    const select = document.getElementById('provider-tier');
    const currentProvider = parseProvider(textarea.value);
    if (currentProvider && ['primary', 'secondary', 'fallback'].includes(currentProvider)) {
        select.value = currentProvider;
    }
});
</script>
{% endblock %}
